<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <title>PBE Score Keeper</title>
  <link href="jquery-ui.min.css" rel="stylesheet">
  <script src="jquery-3.7.1.min.js"></script>
  <script src="jquery-ui.min.js"></script>
  <script>
    $(document).ready(initialize_display);

    var current_session;
    initialize_state();

    function initialize_display() {
      //Set up Accordion display
      $("#accordion").accordion({
        heightStyle: "content"
      });

      //Set up score entry buttons
      $( "#question_score" ).controlgroup();
      $( "#question_block" ).controlgroup();
      $( "#rounding" ).controlgroup();

      //Block multi-line question titles
      $("#current_question_title").keypress(function(e){ 
        if (e.which == 13) {
          $("#current_question_title").trigger("onblur");
          return false;
        } else {
          return true;
        } 
      });
      $("#session_name").keypress(function(e){ 
        if (e.which == 13) {
          $("#session_name").trigger("onblur");
          return false;
        } else {
          return true;
        } 
      });
      
      sync_data_to_display();
    }
    
    function initialize_state() {

      //Get Data Version and upgrade if needed
      var data_version = JSON.parse(get_element("data_version"));
      //No data version means this is a first run. Initialize data state
      if (data_version === null) {
        var d = new Date();
        var date = d.toLocaleString();
        initial_state = {
          "data_version": 1.2,
          "session_names": ["", "Session "+date],
          "current_session": 1,
          "session_1_max_points_per_question": 12,
          "session_1_rounding": "false",
          "session_1_block_names": ["No Block/Group", "Block/Group 1"],
          "session_1_team_names": ["", "Team 1"],
          "session_1_question_names": ["", "Question 1"],
          "session_1_current_question": 1,
          "session_1_question_1_score": 0,
          "session_1_question_1_block": 0,
          "session_1_question_1_ignore": "false",
          "session_1_question_1_team_1_score": 0
        };
        //Save it
        for (let [key, value] of Object.entries(initial_state)) {
          set_element(key, JSON.stringify(value));
        }
        
      } 
      //Make sure datasctructure is current
      data_upgrades(data_version);

      //Load current session from previously saved data
      current_session = get_element("current_session");
    }

    function local_data_update(record) {
      update_data_element(record.id, record.value);

      sync_data_to_display();
    }
    
    function external_data_update(record) {
      sync_data_to_display();
    }

    function update_data_element(updated_id, new_value) {
      const team_name_check = /team_([0-9]+)_name/;
      const block_name_check = /block_([0-9]+)_name/;
      const question_max_points_check = /question_score_([0-9]+)/;
      const question_block_check = /question_block_([0-9]+)/;
      const team_question_score_check = /team_([0-9]+)_score_([0-9]+)/;

      //Update Session Name
      if (updated_id == "session_name") {
        new_value = $("#session_name").text();
        session_names = JSON.parse(get_element("session_names"));
        session_names[current_session] = new_value;
        set_element("session_names", JSON.stringify(session_names));
        $("#session_quick_nav").focus();
      }
      //Goto next session
      else if (updated_id == "new_session") {
        question_names = JSON.parse(get_element("session_"+current_session+"_question_names"));
        question_count = question_names.length - 1;
        if (Number(get_element("session_"+current_session+"_question_"+question_count+"_score")) == 0) {
          question_count--;
        }
        if (question_count > 1) {
          session_names = JSON.parse(get_element("session_names"));
          //Get current settings to copy them forward
          temp_max_points = get_element("session_"+current_session+"_max_points_per_question");
          temp_rounding = get_element("session_"+current_session+"_rounding");
          temp_block_names = get_element("session_"+current_session+"_block_names");
          temp_team_names = get_element("session_"+current_session+"_team_names");
          mythical_option = false;

          //Move Current session forward one
          current_session = session_names.length;
          set_element("current_session", current_session);

          //Set up session defaults since there isn't one for this
          var d = new Date();
          var date = d.toLocaleString();
          session_names.push("Session "+date);
          set_element("session_names", JSON.stringify(session_names));
          set_element("session_"+current_session+"_max_points_per_question", (mythical_option?JSON.stringify(12):temp_max_points));
          set_element("session_"+current_session+"_rounding", (mythical_option?JSON.stringify("false"):temp_rounding));
          set_element("session_"+current_session+"_block_names", (mythical_option?JSON.stringify(["No Block/Group", "Block/Group 1"]):temp_block_names));
          set_element("session_"+current_session+"_team_names", (mythical_option?JSON.stringify(["", "Team 1"]):temp_team_names));
          set_element("session_"+current_session+"_question_names", JSON.stringify(["", "Question 1"]));
          set_element("session_"+current_session+"_current_question", JSON.stringify(1));
          set_element("session_"+current_session+"_question_1_score", JSON.stringify(0));
          set_element("session_"+current_session+"_question_1_ignore", JSON.stringify("false"));
          set_element("session_"+current_session+"_question_1_block", JSON.stringify(0));
          set_element("session_"+current_session+"_question_1_team_1_score", JSON.stringify(0));
        }
      }

      //Jump to specific session
      else if (updated_id == "session_quick_nav") {
        set_element("current_session", new_value);
        current_session = new_value;
      }
      
      //Increase total teams count
      else if (updated_id == "total_teams_increase") {
        team_names = JSON.parse(get_element("session_"+current_session+"_team_names"));
        team_names.push("Team "+team_names.length);
        set_element("session_"+current_session+"_team_names", JSON.stringify(team_names));
        for (i = 1; i < JSON.parse(get_element("session_"+current_session+"_question_names")).length; i++) {
          //Add an empty placeholder score
          set_element("session_"+current_session+"_question_"+i+"_team_"+(team_names.length - 1)+"_score", 0);
        }
      } 
      //Decrease total teams count
      else if (updated_id == "total_teams_decrease") {
        team_names = JSON.parse(get_element("session_"+current_session+"_team_names"));
        if (team_names.length > 2) {
          if (window.confirm("Do you really want Delete "+team_names.pop()+"?")) {
            set_element("session_"+current_session+"_team_names", JSON.stringify(team_names));
            for (i = 1; i < JSON.parse(get_element("session_"+current_session+"_question_names")).length; i++) {
              //Remove deleted Team's score(s)
              remove_element("session_"+current_session+"_question_"+i+"_team_"+team_names.length+"_score");
            }
          }
        }
      } 
      //Update Team Name
      else if (updated_id.search(team_name_check) > -1) {
        team_names = JSON.parse(get_element("session_"+current_session+"_team_names"));
        updated_team_number = updated_id.match(team_name_check)[1];
        team_names[updated_team_number] = new_value;
        set_element("session_"+current_session+"_team_names", JSON.stringify(team_names))
      }
      //Increase total Block/Group Count
      if (updated_id == "total_blocks_increase") {
        block_names = JSON.parse(get_element("session_"+current_session+"_block_names"));
        block_names.push("Block/Group "+block_names.length);
        set_element("session_"+current_session+"_block_names", JSON.stringify(block_names));
      } 
      //Decrease total Blocks/Groups count
      else if (updated_id == "total_blocks_decrease") {
        block_names = JSON.parse(get_element("session_"+current_session+"_block_names"));
        //Don't allow deleting of blocks that are in use
        question_names = JSON.parse(get_element("session_"+current_session+"_question_names"));
        var question_count = question_names.length - 1;
        var smallest_valid_number_of_blocks = 1;
        for (i = 1; i <= question_count; i++) {
          temp_max_blocks = Number(get_element("session_"+current_session+"_question_"+i+"_block"));
          if (smallest_valid_number_of_blocks < temp_max_blocks) {
            smallest_valid_number_of_blocks = temp_max_blocks;
          }
        }
        if (block_names.length > (smallest_valid_number_of_blocks + 1)) {
          block_names.pop();
          set_element("session_"+current_session+"_block_names", JSON.stringify(block_names));
        }
      } 
      //Update Block/Group Name
      else if (updated_id.search(block_name_check) > -1) {
        block_names = JSON.parse(get_element("session_"+current_session+"_block_names"));
        updated_block_number = updated_id.match(block_name_check)[1];
        block_names[updated_block_number] = new_value;
        set_element("session_"+current_session+"_block_names", JSON.stringify(block_names))
      }
      //Increase Max Points per Question
      if (updated_id == "max_points_increase") {
        max_points = get_element("session_"+current_session+"_max_points_per_question");
        max_points++;
        set_element("session_"+current_session+"_max_points_per_question", max_points);
      } 
      //Decrease Max Points per Question
      else if (updated_id == "max_points_decrease") {
        max_points = get_element("session_"+current_session+"_max_points_per_question");

        //Find largest actual max points and prevent max per question from going below that number
        question_names = JSON.parse(get_element("session_"+current_session+"_question_names"));
        var question_count = question_names.length - 1;
        var smallest_valid_max_points = 1;
        for (i = 1; i <= question_count; i++) {
          temp_max_points = Number(get_element("session_"+current_session+"_question_"+i+"_score"));
          if (smallest_valid_max_points < temp_max_points) {
            smallest_valid_max_points = temp_max_points;
          }
        }
        if (max_points > smallest_valid_max_points) {
          max_points--;
          set_element("session_"+current_session+"_max_points_per_question", max_points);
        }
      }
      //Update Question Title
      else if (updated_id == "current_question_title") {
        new_value = $("#current_question_title").text();
        current_question = get_element("session_"+current_session+"_current_question");
        question_names = JSON.parse(get_element("session_"+current_session+"_question_names"));
        question_names[current_question] = new_value;
        set_element("session_"+current_session+"_question_names", JSON.stringify(question_names));
        $("#question_quick_nav").focus();
      }
      //Update Rounding Status to Yes
      else if (updated_id == "rounding_yes") {
          set_element("session_"+current_session+"_rounding", JSON.stringify("true"));
      }
      //Update Rounding Status to No
      else if (updated_id == "rounding_no") {
          set_element("session_"+current_session+"_rounding", JSON.stringify("false"));
      }
      //Update Ignore Question Status
      else if (updated_id == "ignore_question") {
          temp = $("#ignore_question").prop("checked");
          set_element("session_"+current_session+"_question_"+current_question+"_ignore", JSON.stringify(temp+""));
      }
      //Update Current Question Max Possible Score
      else if (updated_id.search(question_max_points_check) > -1) {
        current_question = get_element("session_"+current_session+"_current_question");
        //Disable selecting max possible score lower than already earned score
        var team_count = (JSON.parse(get_element("session_"+current_session+"_team_names"))).length - 1;
        var temp_max = 0;
        for (i = 1; i <= team_count; i++) {
          if (temp_max < Number(get_element("session_"+current_session+"_question_"+current_question+"_team_"+i+"_score"))) {
            temp_max = Number(get_element("session_"+current_session+"_question_"+current_question+"_team_"+i+"_score"));
          }
        }
        if (new_value >= temp_max) {
          set_element("session_"+current_session+"_question_"+current_question+"_score", new_value);
        }
      }
      //Update Current Question's Block/Group
      else if (updated_id.search(question_block_check) > -1) {
        current_question = get_element("session_"+current_session+"_current_question");
        set_element("session_"+current_session+"_question_"+current_question+"_block", new_value);
      }
      //Update score for a team on the current question
      else if (updated_id.search(team_question_score_check) > -1) {
        current_question = get_element("session_"+current_session+"_current_question");
        team_number = updated_id.match(team_question_score_check)[1];
        set_element("session_"+current_session+"_question_"+current_question+"_team_"+team_number+"_score", new_value);
      }
      //Go forward one question
      else if (updated_id == "next_question" || updated_id == "next_question_2") {
        current_question = get_element("session_"+current_session+"_current_question");
        question_names = JSON.parse(get_element("session_"+current_session+"_question_names"));
        var question_count = question_names.length - 1;
        if (current_question == question_count) {
          //Only move forward if current question has a max possible score set
          question_max_points = Number(get_element("session_"+current_session+"_question_"+current_question+"_score"));
          if (question_max_points > 0) {
            //Add a new question

            //Move current Question forward one
            current_question++;
            set_element("session_"+current_session+"_current_question", current_question);

            //Add new question name
            question_names.push("Question "+current_question);
            set_element("session_"+current_session+"_question_names", JSON.stringify(question_names));

            //Set new question possible score to 0
            set_element("session_"+current_session+"_question_"+current_question+"_score", 0);

            //Set new question block/group to 0 (aka none)
            set_element("session_"+current_session+"_question_"+current_question+"_block", 0);

            //Set new question to not be ignored
            set_element("session_"+current_session+"_question_"+current_question+"_ignore", JSON.stringify("false"));

            //Set default score for all teams on this question to 0
            var team_count = (JSON.parse(get_element("session_"+current_session+"_team_names"))).length - 1;
            for (i = 1; i <= team_count; i++) {
              set_element("session_"+current_session+"_question_"+current_question+"_team_"+i+"_score", 0);
            }
          }
        } else {
          //Move forward to existing quesiton
          current_question++;
          set_element("session_"+current_session+"_current_question", current_question);
        }
      }
      //Go to previous question
      else if (updated_id == "previous_question" || updated_id == "previous_question_2") {
        current_question = get_element("session_"+current_session+"_current_question");
        if (current_question > 1) {
          current_question--;
          set_element("session_"+current_session+"_current_question", current_question);
        }
      }
      //Jump to specific question
      else if (updated_id == "question_quick_nav") {
        set_element("session_"+current_session+"_current_question", new_value);
      }
      //Export team data for session
      else if (updated_id == "export_team") {
        let temp = get_team_score_summary();
        downloadBlob(arrayToCsv(temp), 'team_data.csv', 'text/csv;charset=utf-8;');
      }
      //Export block data for session
      else if (updated_id == "export_block") {
        let temp = get_block_score_summary();
        downloadBlob(arrayToCsv(temp), 'block_data.csv', 'text/csv;charset=utf-8;');
      }
      //Export team and block data for session
      else if (updated_id == "export_team_and_block") {
        let temp = get_team_and_block_score_summary();
        downloadBlob(arrayToCsv(temp), 'team_and_block_data.csv', 'text/csv;charset=utf-8;');
      }
      //Export question log data for session
      else if (updated_id == "export_question_log") {
        let temp = get_question_log();
        downloadBlob(arrayToCsv(temp), 'question_log_data.csv', 'text/csv;charset=utf-8;');
      }
      //Export session to JSON
      else if (updated_id == "export_session_json") {
        downloadBlob(JSON.stringify(get_all_data(), filter_to_current_session, 2).replaceAll(" \"session_"+current_session+"_", " \"session_1_"), 'pbe_session_data_' + (new Date().toJSON().slice(0,10)) + '.json', 'application/json; charset=utf-8;');
      }
      //Export all to JSON
      else if (updated_id == "export_all_json") {
        downloadBlob(JSON.stringify(get_all_data(), null, 2), 'all_pbe_score_data_' + (new Date().toJSON().slice(0,10)) + '.json', 'application/json; charset=utf-8;');
      }
      //Delete current session
      else if (updated_id == "session_delete") {
        //Only Delete if more than one session exists
        session_names = JSON.parse(get_element("session_names"));
        if (session_names.length > 2) {
          if (window.confirm("Are you sure you want to irreversably delete this Session (Round/Game)?")) {
            //Use loop starting with current session number to prevent accidental overwriting
            for (i = current_session; i < session_names.length; i++) {
              session_check = new RegExp(`session_${i}_(.*)`);
              new_session = i - 1;
              for (let key of Object.keys(get_all_data())) {
                if (key.search(session_check) > -1) {
                  if (i == current_session) {
                  //Erase Current Session's data
                    remove_element(key);
                  } else {
                    //Renumber all sessions after current session
                    temp = key.replace(session_check,"session_"+(new_session)+"_$1")
                    set_element(temp, get_element(key));
                    remove_element(key);
                  }
                }
              }
            }
            //Delete the current session
            session_names.splice(current_session, 1);
            set_element("session_names", JSON.stringify(session_names));

            if (current_session > session_names.length - 1) {
              current_session--;
              set_element("current_session", current_session);
            }
          }
          alert("Deleted")
        }
        else {
          alert("You may not delete the only Session (Round/Game)");
        }
      }
    }
    
    function sync_data_to_display() {
      //Load "Universal" DB data into variables
      session_names = JSON.parse(get_element("session_names"));
      session_count = session_names.length - 1;
      max_points = JSON.parse(get_element("session_"+current_session+"_max_points_per_question"));
      rounding = JSON.parse(get_element("session_"+current_session+"_rounding"));
      team_names = JSON.parse(get_element("session_"+current_session+"_team_names"));
      var team_count = team_names.length - 1;
      block_names = JSON.parse(get_element("session_"+current_session+"_block_names"));
      var block_count = block_names.length - 1;
      question_names = JSON.parse(get_element("session_"+current_session+"_question_names"));
      question_count = question_names.length - 1;
      if (Number(get_element("session_"+current_session+"_question_"+question_count+"_score")) == 0) {
        question_count--;
      }
      current_question = get_element("session_"+current_session+"_current_question");
      current_selected_block = JSON.parse(get_element("session_"+current_session+"_question_"+current_question+"_block"));
      question_max_points = Number(get_element("session_"+current_session+"_question_"+current_question+"_score"));
      ignore_question = JSON.parse(get_element("session_"+current_session+"_question_"+current_question+"_ignore"));

      //Update Session name to saved name
      $("#session_name").text(session_names[current_session]);

      //Set up Session quick navigation
      session_quick_nav = '<select name="session_quick_nav" id="session_quick_nav" onchange="local_data_update(this)"">';
      temp_count = (current_session>session_count?current_session:session_count);
      for (i=1; i <= temp_count; i++) {
        if (i==current_session) {
          session_quick_nav += '<option value="'+i+'" selected>'+i+" of "+session_count+'</option>';
        } else {
          session_quick_nav += '<option value="'+i+'">'+i+" of "+session_count+' - '+session_names[i]+'</option>';
        }
      }
      session_quick_nav += '</select>';
      $("#session_display_count").html(session_quick_nav);

      //Disable Next Session Button if this Session has no data
      if (question_count > 1) {
        $("#new_session").prop("disabled", false);
      } else {
        $("#new_session").prop("disabled", true);
      }
      
      //Set up Summary Stats here so that those calculations can be reused elsewhere
      //Update Team Scores
      team_score_summary = get_team_score_summary();
  
      //Fill in Team Placement and create output table
      temp_output = "<table><thead><tr><th>Team Name</th><th>Percent</th><th>Score</th><th>Placement</th></tr></thead><tbody>";
      for (i=1; i <= team_count; i++) {
        temp_output = temp_output+"<tr><td>"+team_score_summary[i][0]+"</td>";
        temp_output = temp_output+"<td>"+team_score_summary[i][1]+"</td>";
        temp_output = temp_output+"<td>"+team_score_summary[i][2]+"</td>";
        temp_output = temp_output+"<td>"+team_score_summary[i][3]+"</td></tr>\n"
      }
      temp_output = temp_output+"</tbody></table>";

      //Update displayed Team Scores
      $("#team_scores").html(temp_output);

      //Update Block/Group Scores
      block_score_summary = get_block_score_summary();

      //Fill in Block/Group Placement and create output table
      temp_output = "<table><thead><tr><th>Block/Group Name</th><th>Percent</th><th>Score</th></tr></thead><tbody>";
      for (i=1; i <= block_count + 1; i++) {
        if (block_score_summary[i][4] > 0) {
          temp_output = temp_output+"<tr><td>"+block_score_summary[i][0]+"</td>";
          temp_output = temp_output+"<td>"+block_score_summary[i][1]+"</td>";
          temp_output = temp_output+"<td>"+block_score_summary[i][2]+"</td></tr>\n"
        }
      }
      temp_output = temp_output+"</tbody></table>";

      //Update displayed Block/Group Scores
      $("#block_scores").html(temp_output);


      //Update Team and Block/Group Scores
      team_and_block_score_summary = get_team_and_block_score_summary();

      //Fill in Team and Block/Group scores and create output table
      temp_output = "<table><thead><tr><th>Team Name</th><th>Block/Group Name</th><th>Percent</th><th>Score</th></tr></thead><tbody>";
      for (i=1; i < team_and_block_score_summary.length; i++) {
        if (team_and_block_score_summary[i][5] > 0) {
          temp_output = temp_output+"<tr><td>"+team_and_block_score_summary[i][0]+"</td>";
          temp_output = temp_output+"<td>"+team_and_block_score_summary[i][1]+"</td>";
          temp_output = temp_output+"<td>"+team_and_block_score_summary[i][2]+"</td>";
          temp_output = temp_output+"<td>"+team_and_block_score_summary[i][3]+"</td></tr>\n";
        }
      }
      temp_output = temp_output+"</tbody></table>";

      //Update displayed Team and Block/Group Scores
      $("#team_and_block_scores").html(temp_output);

      //Update displayed Question Log
      //Create empty summary array
      question_log_summary = get_question_log();
      
      //Fill in Team and Block/Group scores and create output table
      temp_output = "<table><thead><tr><th>Question</th><th>Block/Group</th><th>Possible Points</th>";
      for (i=1; i <= team_count; i++) {
        temp_output = temp_output + "<th>"+team_names[i]+" Score</th>";
      }
      temp_output = temp_output + "</tr></thead><tbody>";
      for (var i=1; i < question_log_summary.length; i++) {
        if (question_log_summary[i][3] === "false") {
          temp_output = temp_output+"<tr><td>"+question_log_summary[i][0]+"</td>";
          temp_output = temp_output+"<td>"+question_log_summary[i][1]+"</td>";
          temp_output = temp_output+"<td>"+question_log_summary[i][2]+"</td>";
          for (j=1; j <= team_count; j++) {
            temp_output = temp_output+"<td>"+question_log_summary[i][j+3]+"</td>";
          }
        }
        temp_output = temp_output+"</tr>\n"
      }
      temp_output = temp_output+"</tbody></table>";

      //Update displayed Question Log
      $("#scores").html(temp_output);
      //Set up Teams

      //Show Team Count
      $("#total_teams").text(team_count);
      if (team_count == 1) {
        $("#total_teams_text").text("team");
        $("#total_teams_decrease").prop("disabled", true);
      } else {
        $("#total_teams_text").text("teams");
        $("#total_teams_decrease").prop("disabled", false);
      }

      //Set up Team Name Editing
      displayed_teams_count = $("#team_names").children().length;
      if (displayed_teams_count < team_count) {
        for (i=displayed_teams_count + 1;i<=team_count;i++) {
          //Add new
          $("#team_names").append('<label>Team '+i+' Name: <input type = "text" name = "team_'+i+'_name" id = "team_'+i+'_name" onchange="local_data_update(this)" value = "'+team_names[i]+'"><br></label>');
          $("#question_teams").append('<fieldset><legend id=team_'+i+'_points_label>Team '+team_names[i]+' Score</legend><div id="team_'+i+'_score"></div></fieldset>');
          $("#team_"+i+"_score").append('<label><input type="radio" id="team_'+i+'_score_0" name="team_'+i+'_score" value=0 onchange="local_data_update(this)">0</label>');
          $( "#team_"+i+"_score" ).controlgroup();
        }
      } else if (displayed_teams_count > team_count) {
        //remove extra
        for (i=displayed_teams_count;i>team_count;i--) {
          $("#team_names").children()[i - 1].remove();
          $("#question_teams").children()[i - 1].remove();
        }
      } else {
        //Already have the right number do nothing
      }

      //Update Team Names (Yes this is ineffecient but the numbers are so small it doesn't really matter)
      for (i=1;i<=team_count;i++) {
        var temp_team_score_summary = get_team_score_summary(current_question);
        var temp_team_and_block_score_summary = get_team_and_block_score_summary(current_question);
        team_and_block_row = (i - 1)*(block_count + 1) + 1 + current_selected_block;
        var temp_team_score = "";
        if (temp_team_score_summary[i][5] > 0) {
          temp_team_score += " "+temp_team_score_summary[i][1]
        }
        if (temp_team_and_block_score_summary[team_and_block_row][5] > 0) {
          temp_team_score +=" ("+
                        block_names[current_selected_block]+" "+
                        temp_team_and_block_score_summary[team_and_block_row][2]+")";
        }
        if (team_names[i].slice(-1).toLowerCase() === "s") {
          $("#team_"+i+"_points_label").text(team_names[i]+"' score"+temp_team_score);
        } else {
          $("#team_"+i+"_points_label").text(team_names[i]+"'s score"+temp_team_score);
        }
        $("#team_"+i+"_name").val(team_names[i]);
      }

      //Set up Blocks/Groups
      
      //Show block/group count
      $("#total_blocks").text(block_count);
      if (block_count == 1) {
        $("#total_blocks_text").text("block/group");
        $("#total_blocks_decrease").prop("disabled", true);
      } else {
        $("#total_blocks_text").text("blocks/groups");
        $("#total_blocks_decrease").prop("disabled", false);
      }

      //Set up Block/Group renaming
      displayed_block_count = $("#block_names").children().length;
      if (displayed_block_count < block_count) {
        for (i=displayed_block_count + 1;i<=block_count;i++) {
          //Add new
          $("#block_names").append('<label>Block/Group '+i+' Name: <input type = "text" name = "block_'+i+'_name" id = "block_'+i+'_name" onchange="local_data_update(this)" value = "'+block_names[i]+'"><br></label>');
          $("#question_block").append('<label><input type="radio" id="question_block_'+i+'" name="question_block" value="'+i+'" onchange="local_data_update(this)"><span id="block_'+i+'_label">'+block_names[i]+'</span></label>');
        }
      }
      else if (displayed_block_count > block_count) {
        //remove extra
        for (i=displayed_block_count;i>block_count;i--) {
          $("#block_names").children()[i - 1].remove();
          $("#question_block").children()[i - 1].remove();
        }
      } else {
        //Already have the right number do nothing
      }

      //Update Block/Group Names (Yes this is ineffecient but the numbers are so small it doesn't really matter)
      for (i=1;i<=block_count;i++) {
        //Destroy and recreate as overly heavy handed technique (that actually works) to update label
        $( "#question_block" ).controlgroup( "destroy" );
        $("#block_"+i+"_label").html(block_names[i]);
        $( "#question_block" ).controlgroup();

        $("#block_"+i+"_name").val(block_names[i]);
        //Check off saved block/group
        if (i == current_selected_block) {
          $("#question_block_"+i).prop("checked", true);
        } else {
          $("#question_block_"+i).prop("checked", false);
        }
      }

      //Add fancy options to new buttons
      $( "#question_block" ).controlgroup( "refresh" );

      //Update Question name to saved name
      $("#current_question_title").text(question_names[current_question]);

      //Set up Question quick navigation
      question_quick_nav = '<select name="question_quick_nav" id="question_quick_nav" onchange="local_data_update(this)"">';
      temp_count = (current_question>question_count?current_question:question_count);
      for (i=1; i <= temp_count; i++) {
        temp_ignore_question = JSON.parse(get_element("session_"+current_session+"_question_"+i+"_ignore"));
        if (i==current_question) {
          question_quick_nav += '<option value="'+i+'" selected>'+(temp_ignore_question == "true"?"ðŸš«":"")+i+" of "+question_count+'</option>';
        } else {
          question_quick_nav += '<option value="'+i+'">'+(temp_ignore_question == "true"?"ðŸš«":"")+i+" of "+question_count+' - '+question_names[i]+'</option>';
        }
      }
      question_quick_nav += '</select>';
      $("#current_question_title_count").html(question_quick_nav);

      //Set up Max Points per Question
      
      //Show block/group count
      $("#max_points").text(max_points);
      if (max_points == 1) {
        $("#max_points_text").text("point");
        $("#max_points_decrease").prop("disabled", true);
      } else {
        $("#max_points_text").text("points");
        $("#max_points_decrease").prop("disabled", false);
      }
      
      //Set up max possible points for all questions
      current_max_possible_points = $("#question_score").children().length;
      if (current_max_possible_points < max_points) {
        for (i=current_max_possible_points + 1;i<=max_points;i++) {
          //Add new
          $("#question_score").append('<label><input type="radio" id="question_score_'+i+'" name="question_score" value='+i+' onchange="local_data_update(this)">'+i+'</label>');
        }
      }
      else if (current_max_possible_points > max_points) {
        //remove extra
        for (i=current_max_possible_points;i>max_points;i--) {
          $("#question_score").children()[i - 1].remove();
        }
      } else {
        //Already have the right number do nothing
      }
      //Select actual score if possible
      for (i=0; i<=max_points; i++) {
        if (i == question_max_points) {
          $("#question_score_" + i).prop("checked", true);
        } else {
          $("#question_score_" + i).prop("checked", false);
        }
      }

      //Disable selecting max possible score lower than already earned score
      var temp_max = 0;
      for (i = 1; i <= team_count; i++) {
        if (temp_max < Number(get_element("session_"+current_session+"_question_"+current_question+"_team_"+i+"_score"))) {
          temp_max = Number(get_element("session_"+current_session+"_question_"+current_question+"_team_"+i+"_score"));
        }
      }
      for (i = 0; i < max_points; i++) {
        if (i < temp_max) {
          $("#question_score_" + i).prop("disabled", true);
        } else {
          $("#question_score_" + i).prop("disabled", false);
        }
      }

      //Add fancy options to new buttons
      $( "#question_score" ).controlgroup( "refresh" );

      //Set up max possible points on this question (for each team)
      for (i=1;i<=team_count;i++) {
        var current_team_and_question_score = get_element("session_"+current_session+"_question_"+current_question+"_team_"+i+"_score");
        var current_point_count = $("#team_"+i+"_score").children().length - 1;
        if (current_point_count < question_max_points) {
          //Add new
          for (j = current_point_count; j <= question_max_points - 1; j++) {
            $("#team_"+i+"_score").append('<label><input type="radio" id="team_'+i+'_score_'+(j + 1)+'" name="team_'+i+'_score" value='+(j + 1)+' onchange="local_data_update(this)">'+(j + 1)+'</label>');
          }
        } else if (current_point_count > question_max_points) {
          //remove extra
          for (j = current_point_count; j > question_max_points; j--) {
            $("#team_"+i+"_score").children()[j].remove();
          }
        } else {
          //Already have the right number do nothing
        }

        //Check off saved score
        $("#team_"+i+"_score_" + current_team_and_question_score).prop("checked", true);

        //Add corrected point options
        $( "#team_"+i+"_score" ).controlgroup("refresh");
      }


      //Show rounding status
      if (rounding == "true") {
        $("#rounding_yes").prop("checked", true);
      } else {
        $("#rounding_no").prop("checked", true);
      }

      //Show ignore status
      if (ignore_question == "true") {
        $("#ignore_question").prop("checked", true);
        $("#ignore_question_warning").show();
        $("#ignored_question").css("opacity", 0.25);
        $("#ignored_question").css("pointer-events", "none");
      } else {
        $("#ignore_question").prop("checked", false);
        $("#ignore_question_warning").hide();
        $("#ignored_question").css("opacity", 1);
        $("#ignored_question").css("pointer-events", "initial");
      }

      //Refresh display
      $( "#rounding" ).controlgroup("refresh");

      //Disable Previous Question Button if this is the first Question
      if (current_question == 1) {
        $("#previous_question").prop("disabled", true);
        $("#previous_question_2").prop("disabled", true);
      } else {
        $("#previous_question").prop("disabled", false);
        $("#previous_question_2").prop("disabled", false);
      }

      //Change Next Question to New Question if that is reality
      if (current_question >= question_count) {
        $("#next_question").text("New Question");
        $("#next_question_2").text("New Question");
      } else {
        $("#next_question").text("Next Question");
        $("#next_question_2").text("Next Question");
      }

      //Disable Next Question Button if max possible points is not set
      if (question_max_points == 0) {
        $("#next_question").prop("disabled", true);
        $("#next_question_2").prop("disabled", true);
      } else {
        $("#next_question").prop("disabled", false);
        $("#next_question_2").prop("disabled", false);
      }
    }

    function data_upgrades(data_version, data = "localStorage") {
      //Data structure upgrades
      //Add in rounding option
      if (data_version == 1.0) {
        var session_names = JSON.parse(get_element("session_names", data));
        for (var i = 1; i < session_names.length; i++) {
            //Add missing data element
            set_element("session_"+i+"_rounding", JSON.stringify("false"), data);
        }
        set_element("data_version", 1.01, data);
      }
      //Add in ignore question option
      if (data_version == 1.01) {
        var current_session = get_element("current_session", data);
        var session_names = JSON.parse(get_element("session_names", data));
        for (var i = 1; i < session_names.length; i++) {
          var question_names = JSON.parse(get_element("session_"+current_session+"_question_names", data));
          var question_count = question_names.length - 1;
          for (j = 1; j <= question_count; j++) {  
            //Add missing data element
            set_element("session_"+i+"_question_"+j+"_ignore", JSON.stringify("false"), data);
          }
        }
        set_element("data_version", 1.2, data);
      }
    }

    function get_element(element_name, data = "localStorage") {
      if (data === "localStorage") {
        return localStorage.getItem(element_name);
      } else {
        return data[element_name];
      }
    }

    function set_element(element_name, element_value, data = "localStorage") {
      if (data === "localStorage") {
        localStorage.setItem(element_name, element_value);
      } else {
        data[element_name] = element_value;
      }
    }

    function remove_element(element_name, data = "localStorage") {
      if (data === "localStorage") {
        localStorage.removeItem(element_name);
      } else {
        delete data[element_name];
      }
    }

    function get_all_data() {
      return localStorage;
    }

    function get_team_score_summary(temp_question_count = -1) {
      if (temp_question_count == -1) {
        var question_count = JSON.parse(get_element("session_"+current_session+"_question_names")).length - 1;
      } else {
        var question_count = temp_question_count;
      }
      var team_names = JSON.parse(get_element("session_"+current_session+"_team_names"));
      var team_count = team_names.length - 1;
      var rounding = JSON.parse(get_element("session_"+current_session+"_rounding"));

      //Create empty summary array
      team_score_summary = new Array();
      team_score_summary.push(["Team Name","Percent","Score","Placement","Earned Points","Total Points", "Total Points (Rounded)"]);
      for (var i=0; i < team_count; i++) {
        team_score_summary.push([team_names[i + 1],,,,,,]);
      }
      //Fill in Team Scores
      highest_team_score = 0;
      for (var i=1; i <= team_count; i++) {
        team_earned = 0;
        team_possible = 0;
        for (var j=1; j <= question_count; j++) {
          temp_ignore_question = JSON.parse(get_element("session_"+current_session+"_question_"+j+"_ignore"));
          if (temp_ignore_question === "false") {
            team_earned += Number(get_element("session_"+current_session+"_question_"+j+"_team_"+i+"_score"));
            team_possible += Number(get_element("session_"+current_session+"_question_"+j+"_score"));
          }
        }
        team_score_summary[i][4] = team_earned;
        team_score_summary[i][5] = team_possible;
        team_score_summary[i][1] = ((team_score_summary[i][4]/team_score_summary[i][5])*100).toFixed(2)+"%";
        team_score_summary[i][2] = team_score_summary[i][4]+"/"+team_score_summary[i][5];
        if (team_earned > highest_team_score) {
          var highest_team_score = team_earned;
        }
      }
      for (var i=1; i <= team_count; i++) {
        team_score_summary[i][6] = highest_team_score;
        if (rounding == "true") {
          temp_total = highest_team_score;
        } else {
          temp_total = team_score_summary[i][5];
        }
        if (team_score_summary[i][4]/temp_total >= 0.9) {
          team_score_summary[i][3] = "First Place";
        } else if (team_score_summary[i][4]/temp_total >= 0.8) {
          team_score_summary[i][3] = "Second Place";
        } else {
          team_score_summary[i][3] = "Third Place";
        }
      }
      return team_score_summary;
    }

    function get_block_score_summary(temp_question_count = -1) {
      if (temp_question_count == -1) {
        var question_count = JSON.parse(get_element("session_"+current_session+"_question_names")).length - 1;
      } else {
        var question_count = temp_question_count;
      }
      var team_count = JSON.parse(get_element("session_"+current_session+"_team_names")).length - 1;
      var block_names = JSON.parse(get_element("session_"+current_session+"_block_names"));
      var block_count = block_names.length - 1;
      var rounding = JSON.parse(get_element("session_"+current_session+"_rounding"));

      //Create empty summary array
      var block_score_summary = new Array();
      block_score_summary.push(["Block/Group Name","Percent","Score","Earned Points","Total Points"]);
      for (var i=0; i <= block_count; i++) {
        block_score_summary.push([block_names[i],,,,]);
      }
      //Fill in Block/Group Scores
      var highest_block_score = 0;
      for (var i=0; i <= block_count; i++) {
        block_earned = 0;
        block_possible = 0;
        for (var j=1; j <= question_count; j++) {
          temp_ignore_question = JSON.parse(get_element("session_"+current_session+"_question_"+j+"_ignore"));
          if (Number(get_element("session_"+current_session+"_question_"+j+"_block")) == i && temp_ignore_question === "false") {
            for (k=1; k <= team_count; k++) {
              block_earned += Number(get_element("session_"+current_session+"_question_"+j+"_team_"+k+"_score"));
              block_possible += Number(get_element("session_"+current_session+"_question_"+j+"_score"));
            }
          }
        }
        block_score_summary[i + 1][3] = block_earned;
        block_score_summary[i + 1][4] = block_possible;
        block_score_summary[i + 1][1] = ((block_score_summary[i + 1][3]/block_score_summary[i + 1][4])*100).toFixed(2)+"%";
        block_score_summary[i + 1][2] = block_score_summary[i + 1][3]+"/"+block_score_summary[i + 1][4];
      }
      return block_score_summary;
    }

    function get_team_and_block_score_summary(temp_question_count = -1) {
      if (temp_question_count == -1) {
        var question_count = JSON.parse(get_element("session_"+current_session+"_question_names")).length - 1;
      } else {
        var question_count = temp_question_count;
      }
      var team_names = JSON.parse(get_element("session_"+current_session+"_team_names"));
      var team_count = team_names.length - 1;
      var block_names = JSON.parse(get_element("session_"+current_session+"_block_names"));
      var block_count = block_names.length - 1;

      //Create empty summary array
      team_and_block_score_summary = new Array();
      team_and_block_score_summary.push(["Team Name","Block/Group Name","Percent","Score","Earned Points","Total Points"]);
      for (var i=1; i <= team_count; i++) {
        for (var j=0; j <= block_count; j++) {
          team_and_block_score_summary.push([team_names[i],block_names[j],,,0,0]);
        }
      }
      //Fill in Team and Block/Group Scores
      for (var i=1; i <= team_count; i++) {
        temp_team_start = (i - 1)*(block_count + 1) + 1;
        for (var j=1; j <= question_count; j++) {
          temp_ignore_question = JSON.parse(get_element("session_"+current_session+"_question_"+j+"_ignore"));
          if (temp_ignore_question === "false") {
            current_selected_block = Number(get_element("session_"+current_session+"_question_"+j+"_block"));
            temp_row_number = temp_team_start + current_selected_block;
            team_and_block_score_summary[temp_row_number][4] += Number(get_element("session_"+current_session+"_question_"+j+"_team_"+i+"_score"));
            team_and_block_score_summary[temp_row_number][5] +=  Number(get_element("session_"+current_session+"_question_"+j+"_score"));
            team_and_block_score_summary[temp_row_number][2] = ((team_and_block_score_summary[temp_row_number][4]/team_and_block_score_summary[temp_row_number][5])*100).toFixed(2)+"%";;
            team_and_block_score_summary[temp_row_number][3] = team_and_block_score_summary[temp_row_number][4]+"/"+team_and_block_score_summary[temp_row_number][5];
          }
        }
      }
      return team_and_block_score_summary;
    }

    function get_question_log(temp_question_count = -1) {
      if (temp_question_count == -1) {
        var question_count = JSON.parse(get_element("session_"+current_session+"_question_names")).length - 1;
      } else {
        var question_count = temp_question_count;
      }
      if (Number(get_element("session_"+current_session+"_question_"+question_count+"_score")) == 0) {
        question_count--;
      }
      var team_names = JSON.parse(get_element("session_"+current_session+"_team_names"));
      var team_count = team_names.length - 1;
      var block_names = JSON.parse(get_element("session_"+current_session+"_block_names"));
      var block_count = block_names.length - 1;

      //Create empty summary array
      var temp_row = new Array();
      temp_row.push("Question");
      temp_row.push("Block/Group");
      temp_row.push("Possible Points");
      temp_row.push("Ignore Question");
      for (var i=1; i <= team_count; i++) {
        temp_row.push(team_names[i]);
      }
      var question_log_summary = Array()
      question_log_summary.push(temp_row);
      
      for (var i=1; i <= question_count; i++) {
        var temp_row = Array();
        temp_row.push(question_names[i]);
        temp_row.push(block_names[Number(get_element("session_"+current_session+"_question_"+i+"_block"))]);
        temp_row.push(Number(get_element("session_"+current_session  +"_question_"+i+"_score")));
        temp_row.push(JSON.parse(get_element("session_"+current_session+"_question_"+i+"_ignore")))
        for (j=1; j <= team_count; j++) {
          temp_row.push(Number(get_element("session_"+current_session+"_question_"+i+"_team_"+j+"_score")));
        }
        question_log_summary.push(temp_row);
      }
      return question_log_summary;
    }

    /** Convert a 2D array into a CSV string
     * Source: https://stackoverflow.com/a/68146412
     */
    function arrayToCsv(data){
      return data.map(row =>
        row
        .map(String)  // convert every value to String
        .map(v => v.replaceAll('"', '""'))  // escape double quotes
        .map(v => `"${v}"`)  // quote it
        .join(',')  // comma-separated
      ).join('\r\n');  // rows starting on new lines
    }

    function filter_to_current_session(key, value) {
      if (key.substring(0,8) == "session_") {
        var temp = "session_" + current_session;
        if (key == "session_names") {
          return JSON.stringify(["", session_names[current_session]]);
        }
        else if (key.substring(0,temp.length) != temp) {
          return undefined;
        }
      }
      
      else if (key == "current_session") {
        return "1";
      }

      return value;
    }

    /** Download contents as a file
     * Source: https://stackoverflow.com/questions/14964035/how-to-export-javascript-array-info-to-csv-on-client-side
     */
    function downloadBlob(content, filename, contentType) {
      // Create a blob
      var blob = new Blob([content], { type: contentType });
      var url = URL.createObjectURL(blob);

      // Create a link to download it
      var pom = document.createElement('a');
      pom.href = url;
      pom.setAttribute('download', filename);
      pom.click();
    }
  </script>
  <style>
    button {
      touch-action: manipulation;
    }
    tr:nth-child(even){
      background-color : #ededed;
    }
  </style>
</head>

<body>

  <div data-role="page" id="main">
    <div data-role="header" class="jqm-header">
      <h1>PBE Score Keeper</h1>
    </div>
    <div id="accordion">
      <h3>Configuration (Session/Round/Game)</h3>
      <div data-role="session_configuration" id="session_configuration">
        <h4>Instructions</h4>
        <p>This is a score keeper for the Pathfinder Bible Experience (aka the Bible Bowl). Please enter your number of teams as well as blocks/groups below so that the scoring grid can be created</p>
        <h5>Data Storage Note</h5>
        <p>Data is stored only on your device, and is not shared in any way with any server. This also means that if you change devices your data will not appear on the new device.</p>
        <h4><span id="session_name" contenteditable="plaintext-only" onblur="local_data_update(this)"></span> (<span id="session_display_count"></span>) <button id="new_session" onclick='local_data_update(this)'>New Session</button></h4>
        <fieldset>
          <legend>Set up your Teams</legend>
          <span id="total_teams"></span> <span id="total_teams_text">teams</span> <button id="total_teams_decrease" onclick='local_data_update(this)'>-</button> <button id="total_teams_increase" onclick='local_data_update(this)'>+</button><br>
          <br>
          <div id="team_names"></div>
        </fieldset>
        <fieldset>
          <legend>Set up your Blocks/Groups</legend>
          <span id="total_blocks"></span> <span id="total_blocks_text">blocks/groups</span> <button id="total_blocks_decrease" onclick='local_data_update(this)'>-</button> <button id="total_blocks_increase" onclick='local_data_update(this)'>+</button><br>
          <br>
          <div id="block_names"></div>
        </fieldset>
        <br>
        <fieldset>
          <legend>Maximum Points per Question</legend>
          <span id="max_points"></span> <span id="max_points_text">points</span> <button id="max_points_decrease" onclick='local_data_update(this)'>-</button> <button id="max_points_increase" onclick='local_data_update(this)'>+</button><br>
        </fieldset>
        <fieldset>
          <legend>First, Second, & Third Place Round to Best Team score?</legend>
          <div id="rounding">
            <label><input type="radio" id="rounding_yes" name="rounding" value="true" onchange="local_data_update(this)"><span>Yes</span></label>
            <label><input type="radio" id="rounding_no" name="rounding" value="false" onchange="local_data_update(this)"><span>No</span></label>
          </div>
        </fieldset>
        <br>
        <br>
        <button onclick="local_data_update(this);$( '#accordion' ).accordion({active: 1});">Enter Scores</button>
      </div>
      <h3>Score Entry</h3>
      <div>
        <div data-role="score_entry">
          <div>
            <button id="previous_question" onclick='local_data_update(this)'>Previous Question</button>
            <button id="next_question" onclick='local_data_update(this)'>Next Question</button>
            <br><br>
            <label><span id="ignore_question_warning" style="font-size: xx-large;display:none">ðŸš«</span><input type="checkbox" id="ignore_question" onchange="local_data_update(this)">Ignore this Question in Score Calculations</label></div>
        <div id="ignored_question">
            <h4><span id="current_question_title" contenteditable="plaintext-only" onblur="local_data_update(this)">Question</span> (<span id="current_question_title_count" ></span>)</h4>
            <fieldset>
              <legend id = "points_legend">Possible Points for Question</legend>
              <div id="question_score">
              </div>
            </fieldset>
            <fieldset>
              <legend>Block/Group</legend>
              <div id="question_block"></div>
            </fieldset>
            <div id = "question_teams"></div>
          </div><br>
          <button id="previous_question_2" onclick='local_data_update(this)'>Previous Question</button>
          <button id="next_question_2" onclick='local_data_update(this)'>Next Question</button>
        </div>
      </div>
      <h3>Score by Team</h3>
      <div>
        <div data-role="team_scores" id="team_scores">
          Team Scores Go Here
        </div>
      </div>
      <h3>Score by Block/Group</h3>
      <div>
        <div data-role="block_scores" id="block_scores">
          Block/Group Scores Go Here
        </div>
      </div>
      <h3>Score by Team & Block/Group</h3>
      <div>
        <div data-role="team_and_block_scores" id="team_and_block_scores">
          Team &amp; Block/Group Scores Go Here
        </div>
      </div>
      <h3>Question Log</h3>
      <div>
        <div data-role="scores" id="scores">
          Question Log Goes Here
        </div>
      </div>
      <h3>Advanced</h3>
      <div>
        <div data-role="Advanced" id="Advanced">
          <fieldset>
            <legend id = "export_csv_label">Export CSV</legend>
            <button id= "export_team" onclick='local_data_update(this)'>Export Score by Team</button><br>
            <button id= "export_block" onclick='local_data_update(this)'>Export Score by Block/Group</button><br>
            <button id= "export_team_and_block" onclick='local_data_update(this)'>Export Score by Team & Block/Group</button><br>
            <button id= "export_question_log" onclick='local_data_update(this)'>Export Question Log</button><br>
          </fieldset>
          <fieldset>
            <legend id = "export_json_label">Export for Importing (JSON)</legend>
            <button id= "export_session_json" onclick='local_data_update(this)'>Export Session (Round/Game)</button><br>
            <button id= "export_all_json" onclick='local_data_update(this)'>Export All</button>
          </fieldset>
          <fieldset>
            <legend id = "danger_label">Danger Zone</legend>
            <button id="session_delete" onclick='local_data_update(this)'>Delete this Session (Round/Game)</button>
          </fieldset>
        </div>
      </div>
    </div>
    <footer><p>Have an idea to make this better? <a target="_blank" href="https://github.com/antgiant/PBE_Score_Keeper/issues">Let me know</a>.</p>
    <p><center>v 1.4.5</center></p></footer>
</body>

</html>