<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PBE Score Keeper</title>
  <link href="jquery-ui.min.css" rel="stylesheet">
  <script src="jquery-3.7.1.min.js"></script>
  <script src="jquery-ui.min.js"></script>
  <script>
    $(document).ready(initialize_display);

    var current_session;
    initialize_state();
    sync_data_to_display();

    function initialize_display() {
      //Setup Accordion display
      $("#accordion").accordion({
        heightStyle: "content"
      });

      //Setup score entry buttons
      $( "#question_score" ).controlgroup();
      $( "#question_block" ).controlgroup();

    }
    
    function initialize_state() {

      //Get Data Version and upgrade if needed
      var data_version = JSON.parse(localStorage.getItem("data_version"));
      //No data version means this is a first run. Initialize data state
      if (data_version === null) {
        var d = new Date();
        var date = d.toLocaleString();
        initial_state = {
          "data_version": 1.0,
          "session_names": ["", date],
          "current_session": 1,
          "session_1_max_points_per_question": 12,
          "session_1_block_names": ["", "1", "2", "3", "4", "5", "6"],
          "session_1_team_names": ["", "1"],
          "session_1_question_names": ["", "1"],
          "session_1_current_question": 1,
          "session_1_question_1_score": "",
          "session_1_question_1_block": "",
          "session_1_question_1_team_1_score": ""
        };
        current_session = 1;
        //Save it to localStorage
        for (let [key, value] of Object.entries(initial_state)) {
          localStorage.setItem(key, JSON.stringify(value));
        }
        
      } //Data structure upgrades go here as else if required
      //else if (condition) {}
      //Load current session from previously saved data
      else {
        current_session = localStorage.getItem("current_session");
      }
    }

    function local_data_update(record) {
      clicked = record.id;
      if (clicked == "total_teams_increase") {
        team_names = JSON.parse(localStorage.getItem("session_"+current_session+"_team_names"));
        team_names.push("Team "+team_names.length);
        localStorage.setItem("session_"+current_session+"_team_names", JSON.stringify(team_names));
        for (i = 1; i <= JSON.parse(localStorage.getItem("session_"+current_session+"_question_names")).length; i++) {
        }
        }
      } else if (clicked == "total_teams_decrease") {
        team_names = JSON.parse(localStorage.getItem("session_"+current_session+"_team_names"));
        if (team_names.length > 2) {
          team_names.pop();
          localStorage.setItem("session_"+current_session+"_team_names", JSON.stringify(team_names));

          //Erase team scores?
        }
      }
    }
    
    function external_data_update(record) {
      
    }
    
    function sync_data_to_display() {
      
      block_names = JSON.parse(localStorage.getItem("session_"+current_session+"_block_names"));
      team_names = JSON.parse(localStorage.getItem("session_"+current_session+"_team_names"));

      var block_count = block_names.length - 1;
      var team_count = team_names.length - 1;

/*    
      //Setup Teams
      //Show Team Count
      $("#teams").val(team_count);

      for (i = 1; i <= team_count; i++) {
        //Add new
        $("#team_names").append('<label>Team ' + i + ' Name: <input type = "text" name = "team' + i + '_name" id = "team' + i + '_name" onchange="setup()" value = "' + team_names[i] + '"><br></label>');
        $("#question_teams").append('<fieldset><legend id=team' + i + '_points_label>Team ' + team_names[i] + ' Score</legend><div id="team' + i + '_score"></div></fieldset>');
        $("#team" + i + "_score").append('<label><input type="radio" id="team' + i + '_score_0" name="team' + i + '_score" value=0 onchange="update_score()">0</label>');
    
        $("#team" + i + "_score").controlgroup();
      }
      
      //Set up Blocks
      $("#blocks").val(block_count);
      $("#total_blocks").text(block_count);
      if (block_count == 1) {
        $("#total_blocks_text").text("block");
      } else {
        $("#total_blocks_text").text("blocks");
      }
      current_block_count = $("#block_names").children().length;
      if (current_block_count < block_count) {
        for (i=current_block_count + 1;i<=block_count;i++) {
          //Add new
          block_names.push(i.toString());
          $("#block_names").append('<label>Block '+i+' Name: <input type = "text" name = "block'+i+'_name" id = "block'+i+'_name" onchange="setup()" value = "'+block_names[i]+'"><br></label>');
          $("#question_block").append('<label><input type="radio" id="question_block_'+i+'" name="question_block" value="'+i+'" onchange="update_score()"><span id="block'+i+'_label">'+block_names[i]+'</span></label>');
        }
      }
      else if (current_block_count > block_count) {
        //remove extra
        for (i=current_block_count;i>block_count;i--) {
          $("#block_names").children()[i - 1].remove();
          $("#question_block").children()[i - 1].remove();
          block_names.pop();
        }
      } else {
        //Already have the right number do nothing
      }
      //Add Possible question points
      //<label><input type="radio" id="question_score_1" name="question_score" value=1 onchange="update_score()">1</label>
      
      //Add fancy options to new buttons
      $( "#question_block" ).controlgroup( "refresh" );
      //Update Block Names (Yes this is ineffecient but the numbers are so small it doesn't really matter)
      for (i=1;i<=block_count;i++) {
        block_names[i] = $("#block"+i+"_name").val();
        $("#block"+i+"_label").text($("#block"+i+"_name").val());
      }

      //Set up Teams
      $("#total_teams").text(team_count);
      if (team_count == 1) {
        $("#total_teams_text").text("team");
      } else {
        $("#total_teams_text").text("teams");
      }
      current_teams_count = $("#team_names").children().length;
      if (current_teams_count < team_count) {
        for (i=current_teams_count + 1;i<=team_count;i++) {
          //Add new
          team_names.push(i.toString());
          $("#team_names").append('<label>Team '+i+' Name: <input type = "text" name = "team'+i+'_name" id = "team'+i+'_name" onchange="setup()" value = "'+team_names[i]+'"><br></label>');
          $("#question_teams").append('<fieldset><legend id=team'+i+'_points_label>Team '+team_names[i]+' Score</legend><div id="team'+i+'_score"></div></fieldset>');
          $("#team"+i+"_score").append('<label><input type="radio" id="team'+i+'_score_0" name="team'+i+'_score" value=0 onchange="update_score()">0</label>');
      
          $( "#team"+i+"_score" ).controlgroup();
        }
      } else if (current_teams_count > team_count) {
        //remove extra
        for (i=current_teams_count;i>team_count;i--) {
          $("#team_names").children()[i - 1].remove();
          $("#question_teams").children()[i - 1].remove();
          team_names.pop();
        }
      } else {
        //Already have the right number do nothing
      }
      
      //Update Team Names (Yes this is ineffecient but the numbers are so small it doesn't really matter)
      for (i=1;i<=team_count;i++) {
        team_names[i] = $("#team"+i+"_name").val();
        if (team_names[i].slice(-1).toLowerCase() === "s") {
          $("#team"+i+"_points_label").text("Team "+team_names[i]+"' score");
        } else {
          $("#team"+i+"_points_label").text("Team "+team_names[i]+"'s score");
        }
      }
      //Save out data
      all_session_data[current_session] = current_session_data;
      localStorage.setItem("sessions", JSON.stringify(all_session_data));

      //Update Question Number
      $("#current_question_title").text("Question " + current_session_data.current_question);
      //Grab a working copy of the question data
      var current_question_data = current_session_data.questions[current_session_data.current_question];
      if (current_question_data === undefined) {
        current_question_data = new Object;
      }

      //Get total points
      var total_points = $("input:radio[name=question_score]:checked").val();
      if (total_points === undefined) {
        total_points = current_question_data.total_points;
        $("#question_score_" + total_points).prop("checked", true);
        //Refresh visual display
        $( "#question_score" ).controlgroup("refresh");
      }
      current_question_data.total_points = total_points;

      //Get Block
      var question_block = $("input:radio[name=question_block]:checked").val();
      if (question_block === undefined) {
        question_block = current_question_data.question_block;
        $("#question_block_" + question_block).prop("checked", true);
        //Refresh visual display
        $( "#question_block" ).controlgroup("refresh");
      }
      current_question_data.question_block = question_block;

      for (i=1;i<=team_count;i++) {
        var current_point_count = $("#team"+i+"_score").children().length - 1;
        if (current_point_count < total_points) {
          //Add new
          for (j=current_point_count;j<=total_points - 1;j++) {
            $("#team"+i+"_score").append('<label><input type="radio" id="team'+i+'_score_'+j+'" name="team'+i+'_score" value='+(j + 1)+' onchange="update_score()">'+(j + 1)+'</label>');
          }
        } else if (current_point_count > total_points) {
          //remove extra
          for (j=current_point_count;j>total_points;j--) {
            $("#team"+i+"_score").children()[j].remove();
          }
        } else {
          //Already have the right number do nothing
        }

        //Add corrected point options
        $( "#team"+i+"_score" ).controlgroup("refresh");
      }
      
      //Save out data
      current_session_data.questions[current_session_data.current_question] = current_question_data;
      all_session_data[current_session] = current_session_data;
      localStorage.setItem("sessions", JSON.stringify(all_session_data));
*/
    }
  </script>
  <style>
    button {
      touch-action: manipulation;
    }
  </style>
</head>

<body>

  <div data-role="page" id="main">
    <div data-role="header" class="jqm-header">
      <h1>PBE Score Keeper</h1>
    </div>
    <div data-role="setup" id="accordion">
      <h3>Setup</h3>
      <div id="setup">
        <h4>Instructions</h4>
        <p>Please enter your number of blocks and teams below so that the scoring grid can be created</p>
        <fieldset>
          <legend>Set up your Teams</legend>

          <span id="total_teams"></span> <span id="total_teams_text">teams</span> <button id="total_teams_increase" onclick='local_data_update(this)'>▲</button> <button id="total_teams_decrease" onclick='local_data_update(this)'>▼</button><br>
          <br>
          <div id="team_names"></div>
        </fieldset>
        <fieldset>
          <legend>Set up your Blocks</legend>
          <span id="total_blocks"></span> <span id="total_blocks_text">blocks</span> <button id="total_blocks_increase" onclick='local_data_update(this)'>▲</button> <button id="total_blocks_decrease" onclick='local_data_update(this)'>▼</button><br>
          <br>
          <div id="block_names"></div>
        </fieldset>
        <br>
        <fieldset>
          <legend>Maximum Points per Question</legend>
          <span id="max_points"></span> <span id="max_points_text">points</span> <button id="max_points_increase" onclick='local_data_update(this)'>▲</button> <button id="max_points_decrease" onclick='local_data_update(this)'>▼</button><br>
        </fieldset>
        <br>
        <button onclick="setup();$( '#accordion' ).accordion({active: 1});">Enter Scores</button>
      </div>
      <h3>Score Entry</h3>
      <div>
        <div data-role="score_entry">
          <h4 id="current_question_title">Question</h4>
          <fieldset>
            <legend id = "points_legend">Possible Points for Question</legend>
            <div id="question_score">
            </div>
        </fieldset>
          <fieldset>
            <legend>Block</legend>
            <div id="question_block"></div>
          </fieldset>
          <div id = "question_teams"></div>
          <br>
          <button>Previous Question</button>
          <button>Next Question</button>
        </div>
      </div>
      <h3>Score by Team</h3>
      <div>
        <div data-role="team_scores">
          Team Scores Go Here
        </div>
      </div>
      <h3>Score by Block</h3>
      <div>
        <div data-role="block_scores">
          Team Scores Go Here
        </div>
      </div>
      <h3>Question Log</h3>
      <div>
        <div data-role="scores">
          Question Log Goes Here
        </div>
      </div>
    </div>
</body>

</html>