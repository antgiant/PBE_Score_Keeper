<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PBE Score Keeper</title>
  <link href="jquery-ui.min.css" rel="stylesheet">
  <script src="jquery-3.7.1.min.js"></script>
  <script src="jquery-ui.min.js"></script>
  <script>
    $(document).ready(initialize);
    //Setup Global Variables
    var max_team_count = 24;
    var max_block_count = 24;

    //Get Data Version and upgrade if needed
    var data_version = JSON.parse(localStorage.getItem("data_version"));
    if (data_version === null) {
      data_version = "1.0";
    }


    //Get Session History
    var session_list = JSON.parse(localStorage.getItem("session_list"));
    if (session_list === null) {
      session_list = new Array();
    }

    //Get/Setup Current Session
    var current_session;
    var session_names;
    var all_session_data;
    var current_session_data;
    if (localStorage.getItem("current_session") !== null) {
      current_session = localStorage.getItem("current_session");
      all_session_data = JSON.parse(localStorage.getItem("sessions"));
      session_names = JSON.parse(localStorage.getItem("session_names"));
      current_session_data = all_session_data[current_session];
    } else {
      session_names = JSON.parse(localStorage.getItem("session_names"));
      if (session_names === null) {
        session_names = new Array();
      }
      all_session_data = JSON.parse(localStorage.getItem("sessions"));
      if (all_session_data === null) {
        all_session_data = new Object();
      }
      var d = new Date();
      localStorage.setItem("current_session", d.toLocaleString());
      current_session = localStorage.getItem("current_session");
      session_names.push(current_session);
      localStorage.setItem("session_names", JSON.stringify(session_names));
      current_session_data = {
        "block_names": ["", "1", "2", "3", "4", "5", "6"],
        "team_names": ["", "1"],
        "current_question": 1,
        "questions": [{},]
      }
      all_session_data[current_session] = current_session_data;
      localStorage.setItem("sessions", JSON.stringify(all_session_data));
    }

    var block_count = current_session_data.block_names.length - 1;
    var team_count = current_session_data.team_names.length - 1;

    function initialize() {
      //Setup Accordion display
      $("#accordion").accordion({
        heightStyle: "content"
      });

      //Setup score entry buttons
      $( "#question_score" ).controlgroup();
      $( "#question_block" ).controlgroup();

      $("#blocks").val(block_count);
      $("#teams").val(team_count);

      //Setup Blocks
      for (i=1;i<=block_count;i++) {
        //Add new
        $("#block_names").append('<label>Block '+i+' Name: <input type = "text" name = "block'+i+'_name" id = "block'+i+'_name" onchange="setup()" value = "'+current_session_data.block_names[i]+'"><br></label>');
        $("#question_block").append('<label><input type="radio" id="question_block_'+i+'" name="question_block" value = '+i+' onchange="update_score()"><span id="block'+i+'_point_label">'+current_session_data.block_names[i]+'</span></label>');
      }

      //Setup Teams
      for (i=1;i<=team_count;i++) {
        //Add new
        $("#team_names").append('<label>Team '+i+' Name: <input type = "text" name = "team'+i+'_name" id = "team'+i+'_name" onchange="setup()" value = "'+current_session_data.team_names[i]+'"><br></label>');
        $("#question_teams").append('<fieldset><legend id=team'+i+'_points_label>Team '+current_session_data.team_names[i]+' Score</legend><div id="team'+i+'_score"></div></fieldset>');
        $("#team"+i+"_score").append('<label><input type="radio" id="team'+i+'_score_0" name="team'+i+'_score" value=0 onchange="update_score()">0</label>');
    
        $( "#team"+i+"_score" ).controlgroup();
      }
      setup();
    }

    function setup() {
      //Set up Blocks
      $("#total_blocks").text(block_count);
      if (block_count == 1) {
        $("#total_blocks_text").text("block");
      } else {
        $("#total_blocks_text").text("blocks");
      }
      current_block_count = $("#block_names").children().length;
      if (current_block_count < block_count) {
        for (i=current_block_count + 1;i<=block_count;i++) {
          //Add new
          current_session_data.block_names.push(i.toString());
          $("#block_names").append('<label>Block '+i+' Name: <input type = "text" name = "block'+i+'_name" id = "block'+i+'_name" onchange="setup()" value = "'+current_session_data.block_names[i]+'"><br></label>');
          $("#question_block").append('<label><input type="radio" id="question_block_'+i+'" name="question_block" value="'+i+'" onchange="update_score()"><span id="block'+i+'_label">'+current_session_data.block_names[i]+'</span></label>');
        }
      }
      else if (current_block_count > block_count) {
        //remove extra
        for (i=current_block_count;i>block_count;i--) {
          $("#block_names").children()[i - 1].remove();
          $("#question_block").children()[i - 1].remove();
          current_session_data.block_names.pop();
        }
      } else {
        //Already have the right number do nothing
      }
      //Add fancy options to new buttons
      $( "#question_block" ).controlgroup( "refresh" );
      //Update Block Names (Yes this is ineffecient but the numbers are so small it doesn't really matter)
      for (i=1;i<=block_count;i++) {
        current_session_data.block_names[i] = $("#block"+i+"_name").val();
        $("#block"+i+"_label").text($("#block"+i+"_name").val());
      }

      //Set up Teams
      $("#total_teams").text(team_count);
      if (team_count == 1) {
        $("#total_teams_text").text("team");
      } else {
        $("#total_teams_text").text("teams");
      }
      current_teams_count = $("#team_names").children().length;
      if (current_teams_count < team_count) {
        for (i=current_teams_count + 1;i<=team_count;i++) {
          //Add new
          current_session_data.team_names.push(i.toString());
          $("#team_names").append('<label>Team '+i+' Name: <input type = "text" name = "team'+i+'_name" id = "team'+i+'_name" onchange="setup()" value = "'+current_session_data.team_names[i]+'"><br></label>');
          $("#question_teams").append('<fieldset><legend id=team'+i+'_points_label>Team '+current_session_data.team_names[i]+' Score</legend><div id="team'+i+'_score"></div></fieldset>');
          $("#team"+i+"_score").append('<label><input type="radio" id="team'+i+'_score_0" name="team'+i+'_score" value=0 onchange="update_score()">0</label>');
      
          $( "#team"+i+"_score" ).controlgroup();
          //Call update score to update the visible point options
          update_score();
        }
      } else if (current_teams_count > team_count) {
        //remove extra
        for (i=current_teams_count;i>team_count;i--) {
          $("#team_names").children()[i - 1].remove();
          $("#question_teams").children()[i - 1].remove();
          current_session_data.team_names.pop();
        }
      } else {
        //Already have the right number do nothing
      }
      
      //Update Team Names (Yes this is ineffecient but the numbers are so small it doesn't really matter)
      for (i=1;i<=team_count;i++) {
        current_session_data.team_names[i] = $("#team"+i+"_name").val();
        if (current_session_data.team_names[i].slice(-1).toLowerCase() === "s") {
          $("#team"+i+"_points_label").text("Team "+current_session_data.team_names[i]+"' score");
        } else {
          $("#team"+i+"_points_label").text("Team "+current_session_data.team_names[i]+"'s score");
        }
      }
      //Save out data
      all_session_data[current_session] = current_session_data;
      localStorage.setItem("sessions", JSON.stringify(all_session_data));

      update_score();
    }

    function update_score() {
      //Update Question Number
      $("#current_question_title").text("Question " + current_session_data.current_question);
      //Grab a working copy of the question data
      var current_question_data = current_session_data.questions[current_session_data.current_question];
      if (current_question_data === undefined) {
        current_question_data = new Object;
      }

      //Get total points
      var total_points = $("input:radio[name=question_score]:checked").val();
      if (total_points === undefined) {
        total_points = current_question_data.total_points;
        $("#question_score_" + total_points).prop("checked", true);
        //Refresh visual display
        $( "#question_score" ).controlgroup("refresh");
      }
      current_question_data.total_points = total_points;

      //Get Block
      var current_question_block = $("input:radio[name=question_block]:checked").val();
      if (current_question_block === undefined) {
        current_question_block = current_question_data.current_question_block;
        $("#question_block_" + current_question_block).prop("checked", true);
        //Refresh visual display
        $( "#question_block" ).controlgroup("refresh");
      }
      current_question_data.current_question_block = current_question_block;

      for (i=1;i<=team_count;i++) {
        var current_point_count = $("#team"+i+"_score").children().length - 1;
        if (current_point_count < total_points) {
          //Add new
          for (j=current_point_count;j<=total_points - 1;j++) {
            $("#team"+i+"_score").append('<label><input type="radio" id="team'+i+'_score_'+j+'" name="team'+i+'_score" value='+(j + 1)+' onchange="update_score()">'+(j + 1)+'</label>');
          }
        } else if (current_point_count > total_points) {
          //remove extra
          for (j=current_point_count;j>total_points;j--) {
            $("#team"+i+"_score").children()[j].remove();
          }
        } else {
          //Already have the right number do nothing
        }

        //Add corrected point options
        $( "#team"+i+"_score" ).controlgroup("refresh");
      }
      
      //Save out data
      current_session_data.questions[current_session_data.current_question] = current_question_data;
      all_session_data[current_session] = current_session_data;
      localStorage.setItem("sessions", JSON.stringify(all_session_data));
    }
  </script>
</head>

<body>

  <div data-role="page" id="main">
    <div data-role="header" class="jqm-header">
      <h1>PBE Score Keeper</h1>
    </div>
    <div data-role="setup" id="accordion">
      <h3>Setup</h3>
      <div id="setup">
        <h4>Instructions</h4>
        <p>Please enter your number of blocks and teams below so that the scoring grid can be created</p>
        <fieldset>
          <legend>Set up your Teams</legend>

          <span id="total_teams"></span> <span id="total_teams_text">teams</span> <button onclick='(team_count<max_team_count?team_count++:"");setup()'>▲</button> <button onclick='(team_count>1?team_count--:"");setup()'>▼</button><br>
          <br>
          <div id="team_names"></div>
        </fieldset>
        <fieldset>
          <legend>Set up your Blocks</legend>
          <span id="total_blocks"></span> <span id="total_blocks_text">blocks</span> <button onclick='(block_count<max_block_count?block_count++:"");setup()'>▲</button> <button onclick='(block_count>1?block_count--:"");setup()'>▼</button><br>
          <br>
          <div id="block_names"></div>
        </fieldset>
        <br>
        <button onclick="setup();$( '#accordion' ).accordion({active: 1});">Enter Scores</button>
      </div>
      <h3>Score Entry</h3>
      <div>
        <div data-role="score_entry">
          <h4 id="current_question_title">Question 1</h4>
          <fieldset>
            <legend id = "points_legend">Possible Points for Question 1</legend>
            <div id="question_score">
              <label><input type="radio" id="question_score_1" name="question_score" value=1 onchange="update_score()">1</label>
              <label><input type="radio" id="question_score_2" name="question_score" value=2 onchange="update_score()">2</label>
              <label><input type="radio" id="question_score_3" name="question_score" value=3 onchange="update_score()">3</label>
              <label><input type="radio" id="question_score_4" name="question_score" value=4 onchange="update_score()">4</label>
              <label><input type="radio" id="question_score_5" name="question_score" value=5 onchange="update_score()">5</label>
              <label><input type="radio" id="question_score_6" name="question_score" value=6 onchange="update_score()">6</label>
              <label><input type="radio" id="question_score_7" name="question_score" value=7 onchange="update_score()">7</label>
              <label><input type="radio" id="question_score_8" name="question_score" value=8 onchange="update_score()">8</label>
              <label><input type="radio" id="question_score_9" name="question_score" value=9 onchange="update_score()">9</label>
              <label><input type="radio" id="question_score_10" name="question_score" value=10 onchange="update_score()">10</label>
              <label><input type="radio" id="question_score_11" name="question_score" value=11 onchange="update_score()">11</label>
              <label><input type="radio" id="question_score_12" name="question_score" value=12 onchange="update_score()">12</label>
            </div>
        </fieldset>
          <fieldset>
            <legend>Block</legend>
            <div id="question_block"></div>
          </fieldset>
          <div id = "question_teams"></div>
          <br>
          <button>Previous Question</button>
          <button>Next Question</button>
        </div>
      </div>
      <h3>Score by Team</h3>
      <div>
        <div data-role="team_scores">
          Team Scores Go Here
        </div>
      </div>
      <h3>Score by Block</h3>
      <div>
        <div data-role="block_scores">
          Team Scores Go Here
        </div>
      </div>
      <h3>Question Log</h3>
      <div>
        <div data-role="scores">
          Question Log Goes Here
        </div>
      </div>
    </div>
</body>

</html>