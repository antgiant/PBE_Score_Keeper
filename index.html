<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PBE Score Keeper</title>
  <link href="jquery-ui.min.css" rel="stylesheet">
  <script src="jquery-3.7.1.min.js"></script>
  <script src="jquery-ui.min.js"></script>
  <script>
    $(document).ready(initialize_display);

    var current_session;
    initialize_state();

    function initialize_display() {
      //Setup Accordion display
      $("#accordion").accordion({
        heightStyle: "content"
      });

      //Setup score entry buttons
      $( "#question_score" ).controlgroup();
      $( "#question_block" ).controlgroup();
      $( "#rounding" ).controlgroup();

      //Block multi-line question titles
      $("#current_question_title").keypress(function(e){ 
        if (e.which == 13) {
          $("#current_question_title").trigger("onblur");
          return false;
        } else {
          return true;
        } 
      });
      $("#session_name").keypress(function(e){ 
        if (e.which == 13) {
          $("#session_name").trigger("onblur");
          return false;
        } else {
          return true;
        } 
      });
      
      sync_data_to_display();
    }
    
    function initialize_state() {

      //Get Data Version and upgrade if needed
      var data_version = JSON.parse(localStorage.getItem("data_version"));
      //No data version means this is a first run. Initialize data state
      if (data_version === null) {
        var d = new Date();
        var date = d.toLocaleString();
        initial_state = {
          "data_version": 1.2,
          "session_names": ["", "Session "+date],
          "current_session": 1,
          "session_1_max_points_per_question": 12,
          "session_1_rounding": "false",
          "session_1_block_names": ["No Block/Group", "Block/Group 1"],
          "session_1_team_names": ["", "Team 1"],
          "session_1_question_names": ["", "Question 1"],
          "session_1_current_question": 1,
          "session_1_question_1_score": 0,
          "session_1_question_1_block": 0,
          "session_1_question_1_ignore": "false",
          "session_1_question_1_team_1_score": 0
        };
        //Save it to localStorage
        for (let [key, value] of Object.entries(initial_state)) {
          localStorage.setItem(key, JSON.stringify(value));
        }
        
      } //Data structure upgrades
      //Add in rounding option
      if (data_version == 1.0) {
        session_names = JSON.parse(localStorage.getItem("session_names"));
        for (i = 1; i < session_names.length; i++) {
            //Add missing data element
            localStorage.setItem("session_"+i+"_rounding", JSON.stringify("false"));
        }
        localStorage.setItem("data_version", 1.01);
      }
      //Add in ignore question option
      if (data_version == 1.01) {
        current_session = localStorage.getItem("current_session");
        session_names = JSON.parse(localStorage.getItem("session_names"));
        for (i = 1; i < session_names.length; i++) {
          question_names = JSON.parse(localStorage.getItem("session_"+current_session+"_question_names"));
          question_count = question_names.length - 1;
          for (j = 1; j <= question_count; j++) {  
            //Add missing data element
            localStorage.setItem("session_"+i+"_question_"+j+"_ignore", JSON.stringify("false"));
          }
        }
        localStorage.setItem("data_version", 1.2);
      }
      //Load current session from previously saved data
      current_session = localStorage.getItem("current_session");
    }

    function local_data_update(record) {
      update_data_element(record.id, record.value);

      sync_data_to_display();
    }
    
    function external_data_update(record) {
      sync_data_to_display();
    }

    function update_data_element(updated_id, new_value) {
      const team_name_check = /team_([0-9]+)_name/;
      const block_name_check = /block_([0-9]+)_name/;
      const question_max_points_check = /question_score_([0-9]+)/;
      const question_block_check = /question_block_([0-9]+)/;
      const team_question_score_check = /team_([0-9]+)_score_([0-9]+)/;

      //Update Session Name
      if (updated_id == "session_name") {
        new_value = $("#session_name").text();
        session_names = JSON.parse(localStorage.getItem("session_names"));
        session_names[current_session] = new_value;
        localStorage.setItem("session_names", JSON.stringify(session_names));
        $("#session_quick_nav").focus();
      }
      //Goto next session
      else if (updated_id == "next_session") {
        question_names = JSON.parse(localStorage.getItem("session_"+current_session+"_question_names"));
        question_count = question_names.length - 1;
        if (Number(localStorage.getItem("session_"+current_session+"_question_"+question_count+"_score")) == 0) {
          question_count--;
        }
        if (question_count > 1) {
          session_names = JSON.parse(localStorage.getItem("session_names"));
          current_session++;
          localStorage.setItem("current_session", current_session);
          if (current_session > (session_names.length - 1)) {
            //Setup session defaults since there isn't one for this
            var d = new Date();
            var date = d.toLocaleString();
            session_names.push("Session "+date);
            localStorage.setItem("session_names", JSON.stringify(session_names));
            localStorage.setItem("session_"+current_session+"_max_points_per_question", JSON.stringify(12));
            localStorage.setItem("session_"+current_session+"_rounding", JSON.stringify("false"));
            localStorage.setItem("session_"+current_session+"_block_names", JSON.stringify(["No Block/Group", "Block/Group 1"]));
            localStorage.setItem("session_"+current_session+"_team_names", JSON.stringify(["", "Team 1"]));
            localStorage.setItem("session_"+current_session+"_question_names", JSON.stringify(["", "Question 1"]));
            localStorage.setItem("session_"+current_session+"_current_question", JSON.stringify(1));
            localStorage.setItem("session_"+current_session+"_question_1_score", JSON.stringify(0));
            localStorage.setItem("session_"+current_session+"_question_1_ignore", JSON.stringify("false"));
            localStorage.setItem("session_"+current_session+"_question_1_block", JSON.stringify(0));
            localStorage.setItem("session_"+current_session+"_question_1_team_1_score", JSON.stringify(0));
          }
        }
      }

      //Goto previous session
      else if (updated_id == "previous_session") {
        if (current_session > 1) {
          current_session--;
          localStorage.setItem("current_session", current_session);
        }
      }

      //Jump to specific session
      else if (updated_id == "session_quick_nav") {
        localStorage.setItem("current_session", new_value);
        current_session = new_value;
      }
      
      //Increase total teams count
      else if (updated_id == "total_teams_increase") {
        team_names = JSON.parse(localStorage.getItem("session_"+current_session+"_team_names"));
        team_names.push("Team "+team_names.length);
        localStorage.setItem("session_"+current_session+"_team_names", JSON.stringify(team_names));
        for (i = 1; i < JSON.parse(localStorage.getItem("session_"+current_session+"_question_names")).length; i++) {
          //Add an empty placeholder score
          localStorage.setItem("session_"+current_session+"_question_"+i+"_team_"+(team_names.length - 1)+"_score", 0);
        }
      } 
      //Decrease total teams count
      else if (updated_id == "total_teams_decrease") {
        team_names = JSON.parse(localStorage.getItem("session_"+current_session+"_team_names"));
        if (team_names.length > 2) {
          if (window.confirm("Do you really want Delete "+team_names.pop()+"?")) {
            localStorage.setItem("session_"+current_session+"_team_names", JSON.stringify(team_names));
            for (i = 1; i < JSON.parse(localStorage.getItem("session_"+current_session+"_question_names")).length; i++) {
              //Remove deleted Team's score(s)
              localStorage.removeItem("session_"+current_session+"_question_"+i+"_team_"+team_names.length+"_score");
            }
          }
        }
      } 
      //Update Team Name
      else if (updated_id.search(team_name_check) > -1) {
        team_names = JSON.parse(localStorage.getItem("session_"+current_session+"_team_names"));
        updated_team_number = updated_id.match(team_name_check)[1];
        team_names[updated_team_number] = new_value;
        localStorage.setItem("session_"+current_session+"_team_names", JSON.stringify(team_names))
      }
      //Increase total Block/Group Count
      if (updated_id == "total_blocks_increase") {
        block_names = JSON.parse(localStorage.getItem("session_"+current_session+"_block_names"));
        block_names.push("Block/Group "+block_names.length);
        localStorage.setItem("session_"+current_session+"_block_names", JSON.stringify(block_names));
      } 
      //Decrease total Blocks/Groups count
      else if (updated_id == "total_blocks_decrease") {
        block_names = JSON.parse(localStorage.getItem("session_"+current_session+"_block_names"));
        //Don't allow deleting of blocks that are in use
        question_names = JSON.parse(localStorage.getItem("session_"+current_session+"_question_names"));
        var question_count = question_names.length - 1;
        var smallest_valid_number_of_blocks = 1;
        for (i = 1; i <= question_count; i++) {
          temp_max_blocks = Number(localStorage.getItem("session_"+current_session+"_question_"+i+"_block"));
          if (smallest_valid_number_of_blocks < temp_max_blocks) {
            smallest_valid_number_of_blocks = temp_max_blocks;
          }
        }
        if (block_names.length > (smallest_valid_number_of_blocks + 1)) {
          block_names.pop();
          localStorage.setItem("session_"+current_session+"_block_names", JSON.stringify(block_names));
        }
      } 
      //Update Block/Group Name
      else if (updated_id.search(block_name_check) > -1) {
        block_names = JSON.parse(localStorage.getItem("session_"+current_session+"_block_names"));
        updated_block_number = updated_id.match(block_name_check)[1];
        block_names[updated_block_number] = new_value;
        localStorage.setItem("session_"+current_session+"_block_names", JSON.stringify(block_names))
      }
      //Increase Max Points per Question
      if (updated_id == "max_points_increase") {
        max_points = localStorage.getItem("session_"+current_session+"_max_points_per_question");
        max_points++;
        localStorage.setItem("session_"+current_session+"_max_points_per_question", max_points);
      } 
      //Decrease Max Points per Question
      else if (updated_id == "max_points_decrease") {
        max_points = localStorage.getItem("session_"+current_session+"_max_points_per_question");

        //Find largest actual max points and prevent max per question from going below that number
        question_names = JSON.parse(localStorage.getItem("session_"+current_session+"_question_names"));
        var question_count = question_names.length - 1;
        var smallest_valid_max_points = 1;
        for (i = 1; i <= question_count; i++) {
          temp_max_points = Number(localStorage.getItem("session_"+current_session+"_question_"+i+"_score"));
          if (smallest_valid_max_points < temp_max_points) {
            smallest_valid_max_points = temp_max_points;
          }
        }
        if (max_points > smallest_valid_max_points) {
          max_points--;
          localStorage.setItem("session_"+current_session+"_max_points_per_question", max_points);
        }
      }
      //Update Question Title
      else if (updated_id == "current_question_title") {
        new_value = $("#current_question_title").text();
        question_number = localStorage.getItem("session_"+current_session+"_current_question");
        question_names = JSON.parse(localStorage.getItem("session_"+current_session+"_question_names"));
        question_names[question_number] = new_value;
        localStorage.setItem("session_"+current_session+"_question_names", JSON.stringify(question_names));
        $("#question_quick_nav").focus();
      }
      //Update Rounding Status to Yes
      else if (updated_id == "rounding_yes") {
          localStorage.setItem("session_"+current_session+"_rounding", JSON.stringify("true"));
      }
      //Update Rounding Status to No
      else if (updated_id == "rounding_no") {
          localStorage.setItem("session_"+current_session+"_rounding", JSON.stringify("false"));
      }
      //Update Ignore Question Status
      else if (updated_id == "ignore_question") {
          temp = $("#ignore_question").prop("checked");
          localStorage.setItem("session_"+current_session+"_question_"+question_number+"_ignore", JSON.stringify(temp+""));
      }
      //Update Current Question Max Possible Score
      else if (updated_id.search(question_max_points_check) > -1) {
        question_number = localStorage.getItem("session_"+current_session+"_current_question");
        //Disable selecting max possible score lower than already earned score
        var team_count = (JSON.parse(localStorage.getItem("session_"+current_session+"_team_names"))).length - 1;
        var temp_max = 0;
        for (i = 1; i <= team_count; i++) {
          if (temp_max < Number(localStorage.getItem("session_"+current_session+"_question_"+question_number+"_team_"+i+"_score"))) {
            temp_max = Number(localStorage.getItem("session_"+current_session+"_question_"+question_number+"_team_"+i+"_score"));
          }
        }
        if (new_value >= temp_max) {
          localStorage.setItem("session_"+current_session+"_question_"+question_number+"_score", new_value);
        }
      }
      //Update Current Question's Block/Group
      else if (updated_id.search(question_block_check) > -1) {
        question_number = localStorage.getItem("session_"+current_session+"_current_question");
        localStorage.setItem("session_"+current_session+"_question_"+question_number+"_block", new_value);
      }
      //Update score for a team on the current question
      else if (updated_id.search(team_question_score_check) > -1) {
        question_number = localStorage.getItem("session_"+current_session+"_current_question");
        team_number = updated_id.match(team_question_score_check)[1];
        localStorage.setItem("session_"+current_session+"_question_"+question_number+"_team_"+team_number+"_score", new_value);
      }
      //Go forward one question
      else if (updated_id == "next_question") {
        question_number = localStorage.getItem("session_"+current_session+"_current_question");
        question_names = JSON.parse(localStorage.getItem("session_"+current_session+"_question_names"));
        var question_count = question_names.length - 1;
        if (question_number == question_count) {
          //Only move forward if current question has a max possible score set
          question_max_points = Number(localStorage.getItem("session_"+current_session+"_question_"+question_number+"_score"));
          if (question_max_points > 0) {
            //Add a new question

            //Move current Question forward one
            question_number++;
            localStorage.setItem("session_"+current_session+"_current_question", question_number);

            //Add new question name
            question_names.push("Question "+question_number);
            localStorage.setItem("session_"+current_session+"_question_names", JSON.stringify(question_names));

            //Set new question possible score to 0
            localStorage.setItem("session_"+current_session+"_question_"+question_number+"_score", 0);

            //Set new question block/group to 0 (aka none)
            localStorage.setItem("session_"+current_session+"_question_"+question_number+"_block", 0);

            //Set default score for all teams on this question to 0
            var team_count = (JSON.parse(localStorage.getItem("session_"+current_session+"_team_names"))).length - 1;
            for (i = 1; i <= team_count; i++) {
              localStorage.setItem("session_"+current_session+"_question_"+question_number+"_team_"+i+"_score", 0);
            }
          }
        } else {
          //Move forward to existing quesiton
          question_number++;
          localStorage.setItem("session_"+current_session+"_current_question", question_number);
        }
      }
      //Go to previous question
      else if (updated_id == "previous_question") {
        question_number = localStorage.getItem("session_"+current_session+"_current_question");
        if (question_number > 1) {
          question_number--;
          localStorage.setItem("session_"+current_session+"_current_question", question_number);
        }
      }
      //Jump to specific question
      else if (updated_id == "question_quick_nav") {
        localStorage.setItem("session_"+current_session+"_current_question", new_value);
      }
    }
    
    function sync_data_to_display() {
      //Load "Universal" DB data into variables
      session_names = JSON.parse(localStorage.getItem("session_names"));
      session_count = session_names.length - 1;
      max_points = JSON.parse(localStorage.getItem("session_"+current_session+"_max_points_per_question"));
      rounding = JSON.parse(localStorage.getItem("session_"+current_session+"_rounding"));
      team_names = JSON.parse(localStorage.getItem("session_"+current_session+"_team_names"));
      var team_count = team_names.length - 1;
      block_names = JSON.parse(localStorage.getItem("session_"+current_session+"_block_names"));
      var block_count = block_names.length - 1;
      question_names = JSON.parse(localStorage.getItem("session_"+current_session+"_question_names"));
      question_count = question_names.length - 1;
      if (Number(localStorage.getItem("session_"+current_session+"_question_"+question_count+"_score")) == 0) {
        question_count--;
      }
      question_number = localStorage.getItem("session_"+current_session+"_current_question");
      current_selected_block = JSON.parse(localStorage.getItem("session_"+current_session+"_question_"+question_number+"_block"));
      question_max_points = Number(localStorage.getItem("session_"+current_session+"_question_"+question_number+"_score"));
      ignore_question = JSON.parse(localStorage.getItem("session_"+current_session+"_question_"+question_number+"_ignore"));
      
      //Disable Previous Session Button if this is the first Session
      if (current_session == 1) {
        $("#previous_session").prop("disabled", true);
      } else {
        $("#previous_session").prop("disabled", false);
      }

      //Update Session name to saved name
      $("#session_name").text(session_names[current_session]);

      //Setup Session quick navigation
      session_quick_nav = '<select name="session_quick_nav" id="session_quick_nav" onchange="local_data_update(this)"">';
      temp_count = (current_session>session_count?current_session:session_count);
      for (i=1; i <= temp_count; i++) {
        if (i==current_session) {
          session_quick_nav += '<option value="'+i+'" selected>'+i+" of "+session_count+'</option>';
        } else {
          session_quick_nav += '<option value="'+i+'">'+i+" of "+session_count+' - '+session_names[i]+'</option>';
        }
      }
      session_quick_nav += '</select>';
      $("#session_display_count").html(session_quick_nav);

      //Disable Next Session Button if this Session has no data
      if (question_count > 1) {
        $("#next_session").prop("disabled", false);
      } else {
        $("#next_session").prop("disabled", true);
      }
      
      //Setup Summary Stats here so that those calculations can be reused elsewhere
      //Update Team Scores
      //Create empty summary array
      team_score_summary = new Array();
      for (i=0; i < team_count; i++) {
        team_score_summary.push([],[],[]);
      }
      //Fill in Team Scores
      highest_team_score = 0;
      for (i=1; i <= team_count; i++) {
        team_earned = 0;
        team_possible = 0;
        for (j=1; j <= question_count; j++) {
          temp_ignore_question = JSON.parse(localStorage.getItem("session_"+current_session+"_question_"+j+"_ignore"));
          if (temp_ignore_question == "false") {
            team_earned += Number(localStorage.getItem("session_"+current_session+"_question_"+j+"_team_"+i+"_score"));
            team_possible += Number(localStorage.getItem("session_"+current_session+"_question_"+j+"_score"));
          }
        }
        team_score_summary[i-1][0] = team_earned;
        team_score_summary[i-1][1] = team_possible;
        if (team_earned > highest_team_score) {
          highest_team_score = team_earned;
        }
      }
      //Fill in Team Placement and create output table
      temp_output = "<table><thead><tr><th>Team Name</th><th>Percent</th><th>Score</th><th>Placement</th></tr></thead><tbody>";
      for (i=1; i <= team_count; i++) {
        if (rounding == "true") {
          temp_total = highest_team_score;
        } else {
          temp_total = team_score_summary[i-1][1];
        }
        if (team_score_summary[i-1][0]/temp_total >= 0.9) {
          team_score_summary[i-1][2] = "First Place";
        } else if (team_score_summary[i-1][0]/temp_total >= 0.8) {
          team_score_summary[i-1][2] = "Second Place";
        } else {
          team_score_summary[i-1][2] = "Third Place";
        }
        temp_output = temp_output+"<tr><td>"+team_names[i]+"</td>";
        temp_output = temp_output+"<td>"+((team_score_summary[i-1][0]/team_score_summary[i-1][1])*100).toFixed(2)+"%</td>";
        temp_output = temp_output+"<td>"+team_score_summary[i-1][0]+"/"+team_score_summary[i-1][1]+"</td>";
        temp_output = temp_output+"<td>"+team_score_summary[i-1][2]+"</td></tr>\n"
      }
      temp_output = temp_output+"</tbody></table>";

      //Update displayed Team Scores
      $("#team_scores").html(temp_output);

      //Update Block/Group Scores
      //Create empty summary array
      block_score_summary = new Array();
      for (i=0; i <= block_count; i++) {
        block_score_summary.push([],[],[]);
      }
      //Fill in Block/Group Scores
      highest_block_score = 0;
      for (i=0; i <= block_count; i++) {
        block_earned = 0;
        block_possible = 0;
        for (j=1; j <= question_count; j++) {
          temp_ignore_question = JSON.parse(localStorage.getItem("session_"+current_session+"_question_"+j+"_ignore"));
          if (Number(localStorage.getItem("session_"+current_session+"_question_"+j+"_block")) == i && temp_ignore_question == "false") {
            for (k=1; k <= team_count; k++) {
              block_earned += Number(localStorage.getItem("session_"+current_session+"_question_"+j+"_team_"+k+"_score"));
              block_possible += Number(localStorage.getItem("session_"+current_session+"_question_"+j+"_score"));
            }
          }
        }
        block_score_summary[i][0] = block_earned;
        block_score_summary[i][1] = block_possible;
        if (block_earned > highest_block_score) {
          highest_block_score = block_earned;
        }
      }
      //Fill in Block/Group Placement and create output table
      temp_output = "<table><thead><tr><th>Block/Group Name</th><th>Percent</th><th>Score</th><th>Placement</th></tr></thead><tbody>";
      for (i=0; i <= block_count; i++) {
        if (block_score_summary[i][1] > 0) {
          if (rounding == "true") {
            temp_total = highest_block_score;
          } else {
            temp_total = block_score_summary[i][1];
          }
          if (block_score_summary[i][0]/temp_total >= 0.9) {
            block_score_summary[i][2] = "First Place";
          } else if (block_score_summary[i][0]/temp_total >= 0.8) {
            block_score_summary[i][2] = "Second Place";
          } else {
            block_score_summary[i][2] = "Third Place";
          }
          temp_output = temp_output+"<tr><td>"+block_names[i]+"</td>";
          temp_output = temp_output+"<td>"+((block_score_summary[i][0]/block_score_summary[i][1])*100).toFixed(2)+"%</td>";
          temp_output = temp_output+"<td>"+block_score_summary[i][0]+"/"+block_score_summary[i][1]+"</td>";
          temp_output = temp_output+"<td>"+block_score_summary[i][2]+"</td></tr>\n"
        }
      }
      temp_output = temp_output+"</tbody></table>";

      //Update displayed Block/Group Scores
      $("#block_scores").html(temp_output);


      //Update Team and Block/Group Scores
      //Create empty summary array
      team_and_block_score_summary = new Array();
      for (i=0; i < team_count; i++) {
        team_and_block_score_summary[i] = new Array();
        for (j=0; j <= block_count; j++) {
          team_and_block_score_summary[i].push([0,0]);
        }
      }
      //Fill in Team and Block/Group Scores
      highest_block_score = 0;
      for (i=1; i <= team_count; i++) {
        for (j=1; j <= question_count; j++) {
          temp_ignore_question = JSON.parse(localStorage.getItem("session_"+current_session+"_question_"+j+"_ignore"));
          if (temp_ignore_question == "false") {
            temp_block = Number(localStorage.getItem("session_"+current_session+"_question_"+j+"_block"));
            team_and_block_score_summary[i-1][temp_block][0] += Number(localStorage.getItem("session_"+current_session+"_question_"+j+"_team_"+i+"_score"));
            team_and_block_score_summary[i-1][temp_block][1] +=  Number(localStorage.getItem("session_"+current_session+"_question_"+j+"_score"));
          }
        }
      }
      //Fill in Team and Block/Group scores and create output table
      temp_output = "<table><thead><tr><th>Team Name</th><th>Block/Group Name</th><th>Percent</th><th>Score</th></tr></thead><tbody>";
      for (i=1; i <= team_count; i++) {
        for (j=0; j <= block_count; j++) {
          if (team_and_block_score_summary[i-1][j][1] > 0) {
            temp_output = temp_output+"<tr><td>"+team_names[i]+"</td>";
            temp_output = temp_output+"<td>"+block_names[j]+"</td>";
            temp_output = temp_output+"<td>"+((team_and_block_score_summary[i-1][j][0]/team_and_block_score_summary[i-1][j][1])*100).toFixed(2)+"%</td>";
            temp_output = temp_output+"<td>"+team_and_block_score_summary[i-1][j][0]+"/"+team_and_block_score_summary[i-1][j][1]+"</td></tr>\n";
          }
        }
      }
      temp_output = temp_output+"</tbody></table>";

      //Update displayed Team and Block/Group Scores
      $("#team_and_block_scores").html(temp_output);

      //Update displayed Question Log
      //Create empty summary array
      question_log_summary = new Array();
      for (i=1; i <= question_count; i++) {
        temp_row = Array();
        temp_row.push(Number(localStorage.getItem("session_"+current_session+"_question_"+i+"_block")));
        temp_row.push(Number(localStorage.getItem("session_"+current_session  +"_question_"+i+"_score")));
        for (j=1; j <= team_count; j++) {
          temp_row.push(Number(localStorage.getItem("session_"+current_session+"_question_"+i+"_team_"+j+"_score")));
        }
        question_log_summary.push(temp_row);
      }
      //Fill in Team and Block/Group scores and create output table
      temp_output = "<table><thead><tr><th>Question</th><th>Block/Group</th><th>Possible Points</th>";
      for (i=1; i <= team_count; i++) {
        temp_output = temp_output + "<th>"+team_names[i]+" Score</th>";
      }
      temp_output = temp_output + "</tr></thead><tbody>";
      for (i=1; i <= question_count; i++) {
        temp_ignore_question = JSON.parse(localStorage.getItem("session_"+current_session+"_question_"+i+"_ignore"));
        if (temp_ignore_question == "false") {
          temp_output = temp_output+"<tr><td>"+question_names[i]+"</td>";
          temp_output = temp_output+"<td>"+block_names[question_log_summary[i-1][0]]+"</td>";
          temp_output = temp_output+"<td>"+question_log_summary[i-1][1]+"</td>";
          for (j=1; j <= team_count; j++) {
            temp_output = temp_output+"<td>"+question_log_summary[i-1][j+1]+"</td>";
          }
          temp_output = temp_output+"</tr>\n"
        }
      }
      temp_output = temp_output+"</tbody></table>";

      //Update displayed Question Log
      $("#scores").html(temp_output);
      //Setup Teams

      //Show Team Count
      $("#total_teams").text(team_count);
      if (team_count == 1) {
        $("#total_teams_text").text("team");
        $("#total_teams_decrease").prop("disabled", true);
      } else {
        $("#total_teams_text").text("teams");
        $("#total_teams_decrease").prop("disabled", false);
      }

      //Setup Team Name Editing
      displayed_teams_count = $("#team_names").children().length;
      if (displayed_teams_count < team_count) {
        for (i=displayed_teams_count + 1;i<=team_count;i++) {
          //Add new
          $("#team_names").append('<label>Team '+i+' Name: <input type = "text" name = "team_'+i+'_name" id = "team_'+i+'_name" onchange="local_data_update(this)" value = "'+team_names[i]+'"><br></label>');
          $("#question_teams").append('<fieldset><legend id=team_'+i+'_points_label>Team '+team_names[i]+' Score</legend><div id="team_'+i+'_score"></div></fieldset>');
          $("#team_"+i+"_score").append('<label><input type="radio" id="team_'+i+'_score_0" name="team_'+i+'_score" value=0 onchange="local_data_update(this)">0</label>');
          $( "#team_"+i+"_score" ).controlgroup();
        }
      } else if (displayed_teams_count > team_count) {
        //remove extra
        for (i=displayed_teams_count;i>team_count;i--) {
          $("#team_names").children()[i - 1].remove();
          $("#question_teams").children()[i - 1].remove();
        }
      } else {
        //Already have the right number do nothing
      }

      //Update Team Names (Yes this is ineffecient but the numbers are so small it doesn't really matter)
      for (i=1;i<=team_count;i++) {
        if (team_names[i].slice(-1).toLowerCase() === "s") {
          $("#team_"+i+"_points_label").text(team_names[i]+"' score");
        } else {
          $("#team_"+i+"_points_label").text(team_names[i]+"'s score");
        }
      }

      //Set up Blocks/Groups
      
      //Show block/group count
      $("#total_blocks").text(block_count);
      if (block_count == 1) {
        $("#total_blocks_text").text("block/group");
        $("#total_blocks_decrease").prop("disabled", true);
      } else {
        $("#total_blocks_text").text("blocks/groups");
        $("#total_blocks_decrease").prop("disabled", false);
      }

      //Setup Block/Group renaming
      displayed_block_count = $("#block_names").children().length;
      if (displayed_block_count < block_count) {
        for (i=displayed_block_count + 1;i<=block_count;i++) {
          //Add new
          $("#block_names").append('<label>Block/Group '+i+' Name: <input type = "text" name = "block_'+i+'_name" id = "block_'+i+'_name" onchange="local_data_update(this)" value = "'+block_names[i]+'"><br></label>');
          $("#question_block").append('<label><input type="radio" id="question_block_'+i+'" name="question_block" value="'+i+'" onchange="local_data_update(this)"><span id="block_'+i+'_label">'+block_names[i]+'</span></label>');
        }
      }
      else if (displayed_block_count > block_count) {
        //remove extra
        for (i=displayed_block_count;i>block_count;i--) {
          $("#block_names").children()[i - 1].remove();
          $("#question_block").children()[i - 1].remove();
        }
      } else {
        //Already have the right number do nothing
      }

      //Update Block/Group Names (Yes this is ineffecient but the numbers are so small it doesn't really matter)
      for (i=1;i<=block_count;i++) {
        //Destroy and recreate as overly heavy handed technique (that actually works) to update label
        $( "#question_block" ).controlgroup( "destroy" );
        $("#block_"+i+"_label").html(block_names[i]);
        $( "#question_block" ).controlgroup();
        //Check off saved block/group
        if (i == current_selected_block) {
          $("#question_block_"+i).prop("checked", true);
        } else {
          $("#question_block_"+i).prop("checked", false);
        }
      }

      //Add fancy options to new buttons
      $( "#question_block" ).controlgroup( "refresh" );

      //Update Question name to saved name
      $("#current_question_title").text(question_names[question_number]);

      //Setup Question quick navigation
      question_quick_nav = '<select name="question_quick_nav" id="question_quick_nav" onchange="local_data_update(this)"">';
      temp_count = (question_number>question_count?question_number:question_count);
      for (i=1; i <= temp_count; i++) {
        temp_ignore_question = JSON.parse(localStorage.getItem("session_"+current_session+"_question_"+i+"_ignore"));
        if (i==question_number) {
          question_quick_nav += '<option value="'+i+'" selected>'+(temp_ignore_question == "true"?"ðŸš«":"")+i+" of "+question_count+'</option>';
        } else {
          question_quick_nav += '<option value="'+i+'">'+(temp_ignore_question == "true"?"ðŸš«":"")+i+" of "+question_count+' - '+question_names[i]+'</option>';
        }
      }
      question_quick_nav += '</select>';
      $("#current_question_title_count").html(question_quick_nav);

      //Set up Max Points per Question
      
      //Show block/group count
      $("#max_points").text(max_points);
      if (max_points == 1) {
        $("#max_points_text").text("point");
        $("#max_points_decrease").prop("disabled", true);
      } else {
        $("#max_points_text").text("points");
        $("#max_points_decrease").prop("disabled", false);
      }
      
      //Setup max possible points for all questions
      current_max_possible_points = $("#question_score").children().length;
      if (current_max_possible_points < max_points) {
        for (i=current_max_possible_points + 1;i<=max_points;i++) {
          //Add new
          $("#question_score").append('<label><input type="radio" id="question_score_'+i+'" name="question_score" value='+i+' onchange="local_data_update(this)">'+i+'</label>');
        }
      }
      else if (current_max_possible_points > max_points) {
        //remove extra
        for (i=current_max_possible_points;i>max_points;i--) {
          $("#question_score").children()[i - 1].remove();
        }
      } else {
        //Already have the right number do nothing
      }
      //Select actual score if possible
      for (i=0; i<=max_points; i++) {
        if (i == question_max_points) {
          $("#question_score_" + i).prop("checked", true);
        } else {
          $("#question_score_" + i).prop("checked", false);
        }
      }

      //Disable selecting max possible score lower than already earned score
      var temp_max = 0;
      for (i = 1; i <= team_count; i++) {
        if (temp_max < Number(localStorage.getItem("session_"+current_session+"_question_"+question_number+"_team_"+i+"_score"))) {
          temp_max = Number(localStorage.getItem("session_"+current_session+"_question_"+question_number+"_team_"+i+"_score"));
        }
      }
      for (i = 0; i < max_points; i++) {
        if (i < temp_max) {
          $("#question_score_" + i).prop("disabled", true);
        } else {
          $("#question_score_" + i).prop("disabled", false);
        }
      }

      //Add fancy options to new buttons
      $( "#question_score" ).controlgroup( "refresh" );

      //Setup max possible points on this question (for each team)
      for (i=1;i<=team_count;i++) {
        var current_team_and_question_score = localStorage.getItem("session_"+current_session+"_question_"+question_number+"_team_"+i+"_score");
        var current_point_count = $("#team_"+i+"_score").children().length - 1;
        if (current_point_count < question_max_points) {
          //Add new
          for (j = current_point_count; j <= question_max_points - 1; j++) {
            $("#team_"+i+"_score").append('<label><input type="radio" id="team_'+i+'_score_'+(j + 1)+'" name="team_'+i+'_score" value='+(j + 1)+' onchange="local_data_update(this)">'+(j + 1)+'</label>');
          }
        } else if (current_point_count > question_max_points) {
          //remove extra
          for (j = current_point_count; j > question_max_points; j--) {
            $("#team_"+i+"_score").children()[j].remove();
          }
        } else {
          //Already have the right number do nothing
        }

        //Check off saved score
        $("#team_"+i+"_score_" + current_team_and_question_score).prop("checked", true);

        //Add corrected point options
        $( "#team_"+i+"_score" ).controlgroup("refresh");
      }


      //Show rounding status
      if (rounding == "true") {
        $("#rounding_yes").prop("checked", true);
      } else {
        $("#rounding_no").prop("checked", true);
      }

      //Show ignore status
      if (ignore_question == "true") {
        $("#ignore_question").prop("checked", true);
        $("#ignore_question_warning").show();
      } else {
        $("#ignore_question").prop("checked", false);
        $("#ignore_question_warning").hide();
      }

      //Refresh display
      $( "#rounding" ).controlgroup("refresh");

      //Disable Previous Question Button if this is the first Question
      if (question_number == 1) {
        $("#previous_question").prop("disabled", true);
      } else {
        $("#previous_question").prop("disabled", false);
      }

      //Disable Next Question Button if max possible points is not set
      if (question_max_points == 0) {
        $("#next_question").prop("disabled", true);
      } else {
        $("#next_question").prop("disabled", false);
      }
    }
  </script>
  <style>
    button {
      touch-action: manipulation;
    }
    tr:nth-child(even){
      background-color : #ededed;
    }
  </style>
</head>

<body>

  <div data-role="page" id="main">
    <div data-role="header" class="jqm-header">
      <h1>PBE Score Keeper</h1>
    </div>
    <div data-role="setup" id="accordion">
      <h3>Setup</h3>
      <div id="setup">
        <h4>Instructions</h4>
        <p>This is a score keeper for the Pathfinder Bible Experience (aka the Bible Bowl). Please enter your number of teams as well as blocks/groups below so that the scoring grid can be created</p>
        <h5>Data Storage Note</h5>
        <p>Data is stored only on your device, and is not shared in any way with any server. This also means that if you change devices your data will not appear on the new device.</p>
        <h4><span id="session_name" contenteditable="plaintext-only" onblur="local_data_update(this)"></span> (<span id="session_display_count"></span>)</h4>
        <button id="previous_session" onclick='local_data_update(this)'>Previous Session</button>
        <button id="next_session" onclick='local_data_update(this)'>Next Session</button>
        <br><br>
        <fieldset>
          <legend>Set up your Teams</legend>
          <span id="total_teams"></span> <span id="total_teams_text">teams</span> <button id="total_teams_increase" onclick='local_data_update(this)'>+</button> <button id="total_teams_decrease" onclick='local_data_update(this)'>-</button><br>
          <br>
          <div id="team_names"></div>
        </fieldset>
        <fieldset>
          <legend>Set up your Blocks/Groups</legend>
          <span id="total_blocks"></span> <span id="total_blocks_text">blocks/groups</span> <button id="total_blocks_increase" onclick='local_data_update(this)'>+</button> <button id="total_blocks_decrease" onclick='local_data_update(this)'>-</button><br>
          <br>
          <div id="block_names"></div>
        </fieldset>
        <br>
        <fieldset>
          <legend>Maximum Points per Question</legend>
          <span id="max_points"></span> <span id="max_points_text">points</span> <button id="max_points_increase" onclick='local_data_update(this)'>+</button> <button id="max_points_decrease" onclick='local_data_update(this)'>-</button><br>
        </fieldset>
        <fieldset>
          <legend>First, Second, & Third Place Round to Best Team score?</legend>
          <div id="rounding">
            <label><input type="radio" id="rounding_yes" name="rounding" value="true" onchange="local_data_update(this)"><span>Yes</span></label>
            <label><input type="radio" id="rounding_no" name="rounding" value="false" onchange="local_data_update(this)"><span>No</span></label>
          </div>
        </fieldset>
        <br>
        <br>
        <button onclick="local_data_update(this);$( '#accordion' ).accordion({active: 1});">Enter Scores</button>
      </div>
      <h3>Score Entry</h3>
      <div>
        <div data-role="score_entry">
          <h4><span id="current_question_title" contenteditable="plaintext-only" onblur="local_data_update(this)">Question</span> (<span id="current_question_title_count" ></span>)</h4>
          <div><label><span id="ignore_question_warning" style="font-size: xx-large;display:none">ðŸš«</span><input type="checkbox" id="ignore_question" onchange="local_data_update(this)">Ignore this Question in Score Calculations</label></div>
          <br>
          <fieldset>
            <legend id = "points_legend">Possible Points for Question</legend>
            <div id="question_score">
            </div>
        </fieldset>
          <fieldset>
            <legend>Block/Group</legend>
            <div id="question_block"></div>
          </fieldset>
          <div id = "question_teams"></div>
          <br>
          <button id="previous_question" onclick='local_data_update(this)'>Previous Question</button>
          <button id="next_question" onclick='local_data_update(this)'>Next Question</button>
        </div>
      </div>
      <h3>Score by Team</h3>
      <div>
        <div data-role="team_scores" id="team_scores">
          Team Scores Go Here
        </div>
      </div>
      <h3>Score by Block/Group</h3>
      <div>
        <div data-role="block_scores" id="block_scores">
          Block/Group Scores Go Here
        </div>
      </div>
      <h3>Score by Team & Block/Group</h3>
      <div>
        <div data-role="team_and_block_scores" id="team_and_block_scores">
          Team &amp; Block/Group Scores Go Here
        </div>
      </div>
      <h3>Question Log</h3>
      <div>
        <div data-role="scores" id="scores">
          Question Log Goes Here
        </div>
      </div>
    </div>
    <footer><p>Have an idea to make this better? <a target="_blank" href="https://github.com/antgiant/PBE_Score_Keeper/issues">Let me know</a>.</p></footer>
</body>

</html>